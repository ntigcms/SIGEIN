{% extends "base.html" %}
{% block title %}Usu√°rios{% endblock %}

{% block content %}
<div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 20px;">
    <h2>Usu√°rios</h2>
    <a href="/users/add">
        <button class="animated-btn">Cadastrar Novo</button>
    </a>
</div>

<!-- Filtros com estilo de campo de pesquisa -->
<div class="filtros-container">

    <div class="filtro-item">
        <label>Nome</label>
        <div class="search-container" data-col="2">
            <input type="text" placeholder="Clique para selecionar..." class="filter-search">
            <span class="arrow">‚ñº</span>
            <div class="options" style="display:none;"></div>
    </div>
    </div>
    <div class="filtro-item">
        <label>Email</label>
        <div class="search-container" data-col="3">
            <input type="text" placeholder="Clique para selecionar..." class="filter-search">
            <span class="arrow">‚ñº</span>
            <div class="options" style="display:none;"></div>
        </div>
    </div>
    <div class="filtro-item">
        <label>Perfil</label>
        <div class="search-container" data-col="4">
            <input type="text" placeholder="Clique para selecionar..." class="filter-search">
            <span class="arrow">‚ñº</span>
            <div class="options" style="display:none;"></div>
        </div>
    </div>
    <div class="filtro-item">
        <label>Status</label>
        <div class="search-container" data-col="5">
            <input type="text" placeholder="Clique para selecionar..." class="filter-search">
            <span class="arrow">‚ñº</span>
            <div class="options" style="display:none;"></div>
        </div>
    </div>

    <!-- Bot√£o para limpar filtros -->
    <div style="display:flex; align-items:center;">
        <button id="clear-filters" class="clear-btn">üßπ Limpar Filtros</button>
    </div>
</div>

<!-- TABELA (ENVOLVIDA EM CARD VISUAL) -->
<div class="table-section">
    <h4>Lista de Usu√°rios</h4>
<table id="usuariosTable" class="data-grid display" style="width:100%; border-collapse: collapse; text-align:left;">
    <thead>
        <tr style="background-color: #0d6efd; color:white;">
            <th><input type="checkbox" id="select-all" onclick="toggleAll(this)"></th>
            <th>ID</th>
            <th>Nome</th>
            <th>Email</th>
            <th>Perfil</th>
            <th>Status</th>
            <th>A√ß√µes</th>
        </tr>
    </thead>
    <tbody>
        {% for user in users %}
        <tr style="border-bottom:1px solid #ccc;">
            <td><input type="checkbox" class="select-item"></td>
        <td>{{ user.id }}</td>
        <td>{{ user.nome }}</td>
        <td>{{ user.email }}</td>
        <td>{{ user.perfil }}</td>
        <td>{{ user.status.capitalize() }}</td>
            <td>
                <a href="/users/edit/{{ user.id }}" title="Editar">
                    <i class="fas fa-pen" style="color:#ffaa00; font-size: 18px; margin-right: 10px; cursor:pointer;"></i></a>
                    
                    <form class="delete-form" data-id="{{ user.id }}"  method="post" style="display:inline;">
                        <button type="submit" style="background:none; border:none; padding:0; cursor:pointer;">
                            <i class="fas fa-trash" style="color:#cc0000; font-size:18px;"></i>
                        </button>
                    </form>
            </td>
        </tr>
            {% endfor %}
        </tbody>
    </table>
</div>,

<style>
    .dataTables_length label {
    display: flex;
    align-items: center;
    gap: 6px; /* espa√ßo entre texto e select */
}

    .dataTables_length select {
    width: auto;
    display: inline-block;
}
</style>

<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

<!-- DataTables -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- CSS VISUAL (SEM DUPLICA√á√ÉO) -->
<link rel="stylesheet" href="{{ request.url_for('static', path='css/equipamentos-grid.css') }}">



<script>
function toggleAll(source) {
    let checkboxes = document.getElementsByClassName('select-item');
    for (let i = 0; i < checkboxes.length; i++) {
        checkboxes[i].checked = source.checked;
    }
}

$(document).ready(function() {
    var table = $('#usuariosTable').DataTable({
        order: [[1, "asc"]],
        columnDefs: [
                    { orderable: false, targets: [0, 6] },
                    { visible: false, targets: [0, 1] } // checkbox oculto
                    ],
        language: {
            emptyTable: "Nenhum usu√°rio encontrado",
            info: "Mostrando _START_ at√© _END_ de _TOTAL_ usu√°rios",
            infoEmpty: "Mostrando 0 at√© 0 de 0 usu√°rios",
            lengthMenu: "Mostrar usu√°rios _MENU_",
            zeroRecords: "Nenhum usu√°rio correspondente encontrado",
            paginate: { first:"Primeira", last:"√öltima", next:"Pr√≥xima", previous:"Anterior" }
        },
        pageLength: 10,
        dom: 'rt<"bottom"l<"info-wrapper"ip>><"clear">'
    });

    // === Inicializa filtros customizados ===
    $('.search-container').each(function() {
        const container = $(this);
        const input = container.find('.filter-search');
        const optionsDiv = container.find('.options');
        const arrow = container.find('.arrow');
        const colIndex = container.data('col');
        const column = table.column(colIndex);
        let selecionados = [];

        const valores = column.data().unique().sort().toArray();

        function renderOptions(lista) {
            optionsDiv.empty();
            lista.forEach(v => {
                const checked = selecionados.includes(v) ? 'checked' : '';
                optionsDiv.append(`
                    <div class="option">
                        <input type="checkbox" value="${v}" ${checked}>
                        <label>${v}</label>
                    </div>
                `);
            });
            optionsDiv.show();
            arrow.addClass('open');
        }
    // Abrir filtro e fechar os outros
    input.on("click", function(e){
    e.stopPropagation();

    // Fecha todos os outros filtros
    $('.search-container').not(container).find('.options').hide();

    // Alterna o filtro atual
    if (optionsDiv.is(":visible")) {
        optionsDiv.hide();
        arrow.removeClass('open');
    } else {
        renderOptions(valores);
    }
});

        input.on('input', function() {
            const query = input.val().toLowerCase();
            const filtradas = valores.filter(v => v.toLowerCase().includes(query));
            renderOptions(filtradas);
        });

        optionsDiv.on('change', 'input[type="checkbox"]', function() {
            const val = $(this).val();
            if (this.checked) selecionados.push(val);
            else selecionados = selecionados.filter(v => v !== val);
            input.val(selecionados.join(', '));
            aplicarFiltro();
        });

        function aplicarFiltro() {
            if (selecionados.length > 0) {
                const regex = selecionados.map(v => '^' + $.fn.dataTable.util.escapeRegex(v) + '$').join('|');
                column.search(regex, true, false).draw();
            } else {
                column.search('').draw();
            }
        }

        $(document).on('click', function(e) {
            if (!$(e.target).closest(container).length) {
                optionsDiv.hide();
                arrow.removeClass('open');
            }
        });

        // Salva refer√™ncia para resetar depois
        container.data('reset', function() {
            selecionados = [];
            input.val('');
            column.search('').draw();
            optionsDiv.hide();
            arrow.removeClass('open');
        });
    });

    // === Bot√£o "Limpar Filtros" ===
    $('#clear-filters').on('click', function() {
        $('.search-container').each(function() {
            const resetFn = $(this).data('reset');
            if (typeof resetFn === 'function') resetFn();
        });
    });
});
</script>

<script>
    // DELETE MODERNO
$(document).on("submit", ".delete-form", function(e) {
    e.preventDefault();

    const form = $(this);
    const userId = form.data("id");

    Swal.fire({
        title: 'Tem certeza?',
        text: "Essa a√ß√£o n√£o poder√° ser desfeita.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#cc0000',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Sim, excluir',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {

            fetch(`/users/delete/${userId}`, {
                method: "POST"
            })
            .then(response => response.json())
            .then(data => {

                if (data.success) {

                    Swal.fire({
                        icon: 'success',
                        title: 'Exclu√≠do!',
                        text: 'Usu√°rio removido com sucesso.',
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => {
                        location.reload();
                    });

                } else {

                    Swal.fire({
                        icon: 'error',
                        title: 'N√£o permitido',
                        text: data.message
                    });

                }

            });
        }
    });
});
</script>

<style>
    /* Garante que o SweetAlert fique acima de tudo */
.swal2-container {
    z-index: 99999 !important;
}
</style>
{% endblock %}

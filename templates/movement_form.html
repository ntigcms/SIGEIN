{% extends "base.html" %}
{% block title %}Movimenta√ß√£o{% endblock %}

{% block content %}
<div class="container">
    <h2>Movimenta√ß√£o de Estoque</h2>

    <form method="post" action="{% if movimento %}/movements/edit/{{ movimento.id }}{% else %}/movements{% endif %}">

        <!-- Categoria -->
        <div class="form-group">
            <label for="category">Categoria</label>
            <select id="category" required>
                <option value="">-- Selecione a categoria --</option>
                {% for cat in categories %}
                    <option value="{{ cat.id }}">{{ cat.nome }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Produto -->
        <div class="form-group">
            <label for="product">Produto</label>
            <select id="product" name="type_id" required disabled>
                <option value="">-- Selecione o produto --</option>
            </select>
        </div>

        <!-- N√∫mero de S√©rie -->
        <div class="form-group" id="serie-container" style="display:none;">
            <label for="serie-select">N√∫mero de S√©rie</label>
            <select id="serie-select">
                <option value="">-- Selecione --</option>
            </select>
        </div>

        <!-- N√∫mero do Tombo -->
        <div class="form-group" id="tombo-container" style="display:none;">
            <label for="tombo-select">N√∫mero do Tombo</label>
            <select id="tombo-select">
                <option value="">-- Selecione --</option>
            </select>
        </div>

        <!-- Unidade de Origem -->
        <div class="form-group">
            <label for="unit_origem">Unidade de Origem</label>
            <select id="unit_origem" name="unit_origem_id" required>
                <option value="">-- Selecione --</option>
            </select>
        </div>

        <!-- Unidade de Destino -->
        <div class="form-group">
            <label for="unit_destino">Unidade de Destino</label>
            <select id="unit_destino" name="unit_destino_id" required>
                <option value="">-- Selecione --</option>
                {% for u in units %}
                    <option value="{{ u.id }}">{{ u.name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Tipo de Movimenta√ß√£o -->
        <div class="form-group">
            <label for="tipo">Tipo de Movimenta√ß√£o</label>
            <select id="tipo" name="tipo" required>
                <option value="">-- Selecione --</option>
                <option value="ENTRADA">Entrada</option>
                <option value="SAIDA">Sa√≠da</option>
                <option value="TRANSFERENCIA">Transfer√™ncia</option>
                <option value="AJUSTE">Ajuste</option>
            </select>
        </div>

        <!-- Quantidade -->
        <div class="form-group">
            <label for="quantidade">Quantidade</label>
            <input type="number" name="quantidade" id="quantidade" min="1" disabled>
        </div>

        <!-- Observa√ß√£o -->
        <div class="form-group">
            <label for="observacao">Observa√ß√£o</label>
            <textarea name="observacao"></textarea>
        </div>

        <!-- Campo oculto para item_id -->
        <input type="hidden" name="item_id" id="item_id">

        <div class="buttons">
    <button type="submit" class="btn-submit">
        {% if movimento %}Atualizar{% else %}Salvar{% endif %}
    </button>

    {% if movimento %}
        <a href="/movements" class="btn-cancel">Voltar</a>
    {% else %}
        <a href="/movements" class="btn-cancel">Cancelar</a>
    {% endif %}
</div>

    </form>
</div>

<style>
    .btn-cancel {
    padding: 11px 24px;
    border-radius: 8px;
    border: 1px solid #cbd5e1;
    color: #334155;
    text-decoration: none;
}

    .btn-cancel:hover {
    background: #f1f5f9;
}
</style>

<script>
const productsData = JSON.parse('{{ products | tojson | safe }}');

const categorySelect = document.getElementById("category");
const productSelect = document.getElementById("product");

const serieContainer = document.getElementById("serie-container");
const serieSelect = document.getElementById("serie-select");

const tomboContainer = document.getElementById("tombo-container");
const tomboSelect = document.getElementById("tombo-select");

const unitOrigemSelect = document.getElementById("unit_origem");
const quantidadeInput = document.getElementById("quantidade");
const itemIdInput = document.getElementById("item_id");

/* ---------------- FUN√á√ÉO PARA ATUALIZAR UNIDADE ---------------- */
function atualizarUnidadeOrigem(unit_id, unit_name, item_id=null) {
    unitOrigemSelect.innerHTML = '';
    if (!unit_id || !unit_name) return; // evita undefined
    const opt = document.createElement("option");
    opt.value = unit_id;
    opt.text = unit_name;
    unitOrigemSelect.appendChild(opt);
    unitOrigemSelect.value = unit_id;
    itemIdInput.value = item_id || '';
}

/* ---------------- CATEGORIA ‚Üí PRODUTO ---------------- */
categorySelect.addEventListener('change', () => {
    const cat = parseInt(categorySelect.value);

    productSelect.innerHTML = '<option value="">-- Selecione o produto --</option>';
    productSelect.disabled = !cat;

    resetItems();
    resetUnidade();
    quantidadeInput.value = '';
    quantidadeInput.disabled = true;

    if (!cat) return;

    const filtered = productsData.filter(p => p.category_id === cat);
    const grouped = {};
    filtered.forEach(p => {
        if (!grouped[p.type_id]) {
            grouped[p.type_id] = {
                type_id: p.type_id,
                type_name: p.type_name,
                controla_por_serie: p.controla_por_serie
            };
        }
    });

    Object.values(grouped).forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.type_id;
        opt.text = p.type_name;
        opt.dataset.controlaPorSerie = p.controla_por_serie;
        productSelect.appendChild(opt);
    });
});

/* ---------------- PRODUTO ---------------- */
productSelect.addEventListener("change", async () => {
    resetItems();
    resetUnidade();
    quantidadeInput.value = '';
    quantidadeInput.disabled = true;
    itemIdInput.value = '';

    const opt = productSelect.selectedOptions[0];
    if (!opt) return;

    const product = productsData.find(p => p.type_id == opt.value);
    if (!product) return;

    const controlaSerie = opt.dataset.controlaPorSerie === "true";

    if (controlaSerie) {
        // Produto com s√©rie/tombo: unidade s√≥ ap√≥s selecionar item
        quantidadeInput.disabled = true;
        await carregarItensFisicos(opt.value);
    } else {
        // Produto sem s√©rie/tombo: preenche automaticamente unidade
        quantidadeInput.disabled = false;

        if (product.unit_id && product.unit_name) {
            unitOrigemSelect.innerHTML = '';
            const optUnit = document.createElement("option");
            optUnit.value = product.unit_id;
            optUnit.text = product.unit_name;
            unitOrigemSelect.appendChild(optUnit);
            unitOrigemSelect.value = product.unit_id;
        }
    }
});

/* ---------------- TOMBO / S√âRIE ---------------- */
async function carregarItensFisicos(type_id) {
    serieSelect.innerHTML = '<option value="">-- Selecione --</option>';
    tomboSelect.innerHTML = '<option value="">-- Selecione --</option>';

    serieContainer.style.display = 'none';
    tomboContainer.style.display = 'none';
    itemIdInput.value = '';

    const res = await fetch(`/movements/items/${type_id}`);
    const itens = await res.json();
    if (!itens.length) return;

    const itensNormalizados = itens.map(i => ({
        ...i,
        isTombo: i.tombo === true || i.tombo === "true" || i.tombo === 1 || i.tombo === "1"
    }));

    const temSerie = itensNormalizados.some(i => !i.isTombo);
    const temTombo = itensNormalizados.some(i => i.isTombo);

    if (temSerie) {
        serieContainer.style.display = "block";
        itensNormalizados.filter(i => !i.isTombo).forEach(i => {
            const opt = document.createElement("option");
            opt.value = i.id;
            opt.text = i.num;
            opt.dataset.unitId = i.unit_id;
            opt.dataset.unitName = i.unit_name;
            serieSelect.appendChild(opt);
        });
    } else if (temTombo) {
        tomboContainer.style.display = "block";
        itensNormalizados.filter(i => i.isTombo).forEach(i => {
            const opt = document.createElement("option");
            opt.value = i.id;
            opt.text = i.num;
            opt.dataset.unitId = i.unit_id;
            opt.dataset.unitName = i.unit_name;
            tomboSelect.appendChild(opt);
        });
    }

    // N√ÉO preenche a unidade automaticamente para produtos que controlam s√©rie/tombo
}

/* ---------------- ITEM ‚Üí UNIDADE AUTOM√ÅTICA ---------------- */
serieSelect.addEventListener("change", () => {
    tomboSelect.value = "";
    const opt = serieSelect.selectedOptions[0];
    if (!opt) return;
    atualizarUnidadeOrigem(opt.dataset.unitId, opt.dataset.unitName, opt.value);
});

tomboSelect.addEventListener("change", () => {
    serieSelect.value = "";
    const opt = tomboSelect.selectedOptions[0];
    if (!opt) return;
    atualizarUnidadeOrigem(opt.dataset.unitId, opt.dataset.unitName, opt.value);
});

/* ---------------- HELPERS ---------------- */
function resetItems() {
    serieContainer.style.display = 'none';
    tomboContainer.style.display = 'none';
    serieSelect.innerHTML = '<option value="">-- Selecione --</option>';
    tomboSelect.innerHTML = '<option value="">-- Selecione --</option>';
    itemIdInput.value = '';
}

function resetUnidade() {
    unitOrigemSelect.innerHTML = '<option value="">-- Selecione --</option>';
}


</script>

<script>
// ‚ùå Corrigido: atribui√ß√£o segura de movimento
window.movimento = {{ movimento | tojson }};

async function carregarModoEdicao() {
    if (!window.movimento || !window.movimento.id) return;

    const m = window.movimento;

    // 1Ô∏è‚É£ Seleciona categoria
    categorySelect.value = m.product.category_id;
    categorySelect.dispatchEvent(new Event('change'));

    // Pequeno delay para popular produtos
    await new Promise(r => setTimeout(r, 50));

    // 2Ô∏è‚É£ Seleciona produto
    productSelect.value = m.product.type_id;
    productSelect.dispatchEvent(new Event('change'));

    // 3Ô∏è‚É£ Espera carregar itens f√≠sicos (se houver)
    await new Promise(r => setTimeout(r, 300));

    if (m.item) {
        if (m.item.tombo) {
            tomboSelect.value = m.item.id;
            tomboSelect.dispatchEvent(new Event('change'));
        } else {
            serieSelect.value = m.item.id;
            serieSelect.dispatchEvent(new Event('change'));
        }
    } else {
        quantidadeInput.value = m.quantidade;
        quantidadeInput.disabled = false;

        // üîπ Define unidade de origem manualmente quando n√£o √© item f√≠sico
        unitOrigemSelect.innerHTML = '';
        const opt = document.createElement("option");
        opt.value = m.unit_origem_id;
        opt.text = "Unidade atual";
        unitOrigemSelect.appendChild(opt);
        unitOrigemSelect.value = m.unit_origem_id;
    }

    // 4Ô∏è‚É£ Destino
    document.getElementById("unit_destino").value = m.unit_destino_id;

    // 5Ô∏è‚É£ Tipo
    document.getElementById("tipo").value = m.tipo;

    // 6Ô∏è‚É£ Observa√ß√£o
    document.querySelector("textarea[name='observacao']").value = m.observacao || '';
}

carregarModoEdicao();
    console.log("MOVIMENTO:", window.movimento);

</script>

{% endblock %}

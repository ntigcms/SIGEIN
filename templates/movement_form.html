{% extends "base.html" %}
{% block title %}Movimentação{% endblock %}

{% block content %}
<div class="container">
    <h2>Movimentação de Estoque</h2>

    <form method="post" action="/movements">

        <!-- Categoria -->
        <div class="form-group">
            <label for="category">Categoria</label>
            <select id="category" required>
                <option value="">-- Selecione a categoria --</option>
                {% for cat in categories %}
                    <option value="{{ cat.id }}">{{ cat.nome }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Produto -->
        <div class="form-group">
            <label for="product">Produto</label>
            <select id="product" name="type_id" required disabled>
                <option value="">-- Selecione o produto --</option>
            </select>
        </div>

        <!-- Número de Série -->
        <div class="form-group" id="serie-container" style="display:none;">
            <label for="serie-select">Número de Série</label>
            <select id="serie-select">
                <option value="">-- Selecione --</option>
            </select>
        </div>

        <!-- Número do Tombo -->
        <div class="form-group" id="tombo-container" style="display:none;">
            <label for="tombo-select">Número do Tombo</label>
            <select id="tombo-select">
                <option value="">-- Selecione --</option>
            </select>
        </div>

        <!-- Unidade de Origem -->
        <div class="form-group">
            <label for="unit_origem">Unidade de Origem</label>
            <select id="unit_origem" name="unit_origem_id" required>
                <option value="">-- Selecione --</option>
            </select>
        </div>

        <!-- Unidade de Destino -->
        <div class="form-group">
            <label for="unit_destino">Unidade de Destino</label>
            <select id="unit_destino" name="unit_destino_id" required>
                <option value="">-- Selecione --</option>
                {% for u in units %}
                    <option value="{{ u.id }}">{{ u.name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Tipo de Movimentação -->
        <div class="form-group">
            <label for="tipo">Tipo de Movimentação</label>
            <select id="tipo" name="tipo" required>
                <option value="">-- Selecione --</option>
                <option value="ENTRADA">Entrada</option>
                <option value="SAIDA">Saída</option>
                <option value="TRANSFERENCIA">Transferência</option>
                <option value="AJUSTE">Ajuste</option>
            </select>
        </div>

        <!-- Quantidade -->
        <div class="form-group">
            <label for="quantidade">Quantidade</label>
            <input type="number" name="quantidade" id="quantidade" min="1" disabled>
        </div>

        <!-- Observação -->
        <div class="form-group">
            <label for="observacao">Observação</label>
            <textarea name="observacao"></textarea>
        </div>

        <!-- Campo oculto para item_id -->
        <input type="hidden" name="item_id" id="item_id">

        <button type="submit">Confirmar</button>
    </form>
</div>

<script>
const productsData = JSON.parse('{{ products | tojson | safe }}');

const categorySelect = document.getElementById("category");
const productSelect = document.getElementById("product");

const serieContainer = document.getElementById("serie-container");
const serieSelect = document.getElementById("serie-select");

const tomboContainer = document.getElementById("tombo-container");
const tomboSelect = document.getElementById("tombo-select");

const unitOrigemSelect = document.getElementById("unit_origem");
const quantidadeInput = document.getElementById("quantidade");
const itemIdInput = document.getElementById("item_id");

/* ---------------- CATEGORIA → PRODUTO ---------------- */
categorySelect.addEventListener('change', () => {
    const cat = parseInt(categorySelect.value);

    productSelect.innerHTML = '<option value="">-- Selecione o produto --</option>';
    productSelect.disabled = !cat;

    resetItems();
    resetUnidade();
    quantidadeInput.value = '';
    quantidadeInput.disabled = true;
    itemIdInput.value = '';

    if (!cat) return;

    const filtered = productsData.filter(p => p.category_id === cat);

    const grouped = {};
    filtered.forEach(p => {
        if (!grouped[p.type_id]) {
            grouped[p.type_id] = {
                type_id: p.type_id,
                type_name: p.type_name,
                controla_por_serie: p.controla_por_serie
            };
        }
    });

    Object.values(grouped).forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.type_id;
        opt.text = p.type_name;
        opt.dataset.controlaPorSerie = p.controla_por_serie;
        productSelect.appendChild(opt);
    });
});

/* ---------------- PRODUTO ---------------- */
productSelect.addEventListener("change", async () => {
    resetItems();
    resetUnidade();
    quantidadeInput.value = '';
    quantidadeInput.disabled = true;
    itemIdInput.value = '';

    const opt = productSelect.selectedOptions[0];
    if (!opt) return;

    const controlaSerie = opt.dataset.controlaPorSerie === "true";

    if (controlaSerie) {
        quantidadeInput.disabled = true;
        await carregarItensFisicos(opt.value);
    } else {
        quantidadeInput.disabled = false;
    }
});

/* ---------------- TOMBO / SÉRIE ---------------- */
async function carregarItensFisicos(type_id) {
    serieSelect.innerHTML = '<option value="">-- Selecione --</option>';
    tomboSelect.innerHTML = '<option value="">-- Selecione --</option>';
    serieContainer.style.display = 'none';
    tomboContainer.style.display = 'none';
    itemIdInput.value = '';

    const res = await fetch(`/movements/items/${type_id}`);
    const itens = await res.json();
    if (!itens.length) return;

    const series = itens.filter(i => !i.tombo);
    const tombos = itens.filter(i => i.tombo);

    if (series.length) {
        serieContainer.style.display = "block";
        series.forEach(i => {
            const opt = document.createElement("option");
            opt.value = i.id;
            opt.text = i.num;
            opt.dataset.unitId = i.unit_id;
            opt.dataset.unitName = i.unit_name;
            serieSelect.appendChild(opt);
        });
    }

    if (tombos.length) {
        tomboContainer.style.display = "block";
        tombos.forEach(i => {
            const opt = document.createElement("option");
            opt.value = i.id;
            opt.text = i.num;
            opt.dataset.unitId = i.unit_id;
            opt.dataset.unitName = i.unit_name;
            tomboSelect.appendChild(opt);
        });
    }
}

/* ---------------- ITEM → UNIDADE AUTOMÁTICA ---------------- */
serieSelect.addEventListener("change", () => {
    tomboSelect.value = "";
    resetUnidade();

    const opt = serieSelect.selectedOptions[0];
    if (!opt) return;

    itemIdInput.value = opt.value;

    const unitOpt = document.createElement("option");
    unitOpt.value = opt.dataset.unitId;
    unitOpt.text = opt.dataset.unitName;
    unitOrigemSelect.innerHTML = '';
    unitOrigemSelect.appendChild(unitOpt);
    unitOrigemSelect.value = unitOpt.value;
});

tomboSelect.addEventListener("change", () => {
    serieSelect.value = "";
    resetUnidade();

    const opt = tomboSelect.selectedOptions[0];
    if (!opt) return;

    itemIdInput.value = opt.value;

    const unitOpt = document.createElement("option");
    unitOpt.value = opt.dataset.unitId;
    unitOpt.text = opt.dataset.unitName;
    unitOrigemSelect.innerHTML = '';
    unitOrigemSelect.appendChild(unitOpt);
    unitOrigemSelect.value = unitOpt.value;
});

/* ---------------- HELPERS ---------------- */
function resetItems() {
    serieContainer.style.display = 'none';
    tomboContainer.style.display = 'none';
    serieSelect.innerHTML = '<option value="">-- Selecione --</option>';
    tomboSelect.innerHTML = '<option value="">-- Selecione --</option>';
    itemIdInput.value = '';
}

function resetUnidade() {
    unitOrigemSelect.innerHTML = '<option value="">-- Selecione --</option>';
}
</script>

{% endblock %}

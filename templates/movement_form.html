{% extends "base.html" %}
{% block title %}Movimentação{% endblock %}

{% block content %}
<div class="container">
    <h2>Movimentação de Estoque</h2>

    <form method="post" action="/movements">

        <!-- Categoria -->
        <div class="form-group">
            <label for="category">Categoria</label>
            <select id="category" required>
                <option value="">-- Selecione a categoria --</option>
                {% for cat in categories %}
                    <option value="{{ cat.id }}">{{ cat.nome }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Produto -->
        <div class="form-group">
            <label for="product">Produto</label>
            <select id="product" name="product_id" required disabled>
                <option value="">-- Selecione o produto --</option>
            </select>
        </div>

        <!-- Unidade de Origem -->
        <div class="form-group">
            <label for="unit_origem">Unidade de Origem</label>
            <select id="unit_origem" name="unit_origem_id" required>
                <option value="">-- Selecione --</option>
            </select>
        </div>

        <!-- Unidade de Destino -->
        <div class="form-group">
            <label for="unit_destino">Unidade de Destino</label>
            <select id="unit_destino" name="unit_destino_id" required>
                <option value="">-- Selecione --</option>
                {% for u in units %}
                    <option value="{{ u.id }}">{{ u.name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Tipo -->
        <div class="form-group">
            <label for="tipo">Tipo de Movimentação</label>
            <select id="tipo" name="tipo" required>
                <option value="">-- Selecione --</option>
                <option value="ENTRADA">Entrada</option>
                <option value="SAIDA">Saída</option>
                <option value="TRANSFERENCIA">Transferência</option>
                <option value="AJUSTE">Ajuste</option>
            </select>
        </div>

        <!-- Quantidade -->
        <div class="form-group">
            <label for="quantidade">Quantidade</label>
            <input type="number" name="quantidade" id="quantidade" min="1" required>
        </div>

        <!-- Observação -->
        <div class="form-group">
            <label for="observacao">Observação</label>
            <textarea name="observacao"></textarea>
        </div>

        <button type="submit">Confirmar</button>
    </form>
</div>

<script>
const productsData = {{ products | tojson | safe }};
const categorySelect = document.getElementById('category');
const productSelect = document.getElementById('product');
const unitOrigemSelect = document.getElementById("unit_origem");
const quantidadeInput = document.getElementById("quantidade");

// Filtra produtos por categoria e exibe pelo tipo
categorySelect.addEventListener('change', () => {
    const cat = categorySelect.value;
    productSelect.innerHTML = '<option value="">-- Selecione o produto --</option>';
    productSelect.disabled = !cat;
    unitOrigemSelect.innerHTML = '<option value="">-- Selecione --</option>';
    quantidadeInput.value = '';
    quantidadeInput.max = '';

    if (!cat) return;

    productsData
        .filter(p => p.category_id == cat)
        .forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.text = p.type_name; // Mostra o tipo do produto
            productSelect.appendChild(opt);
        });
});

// Carrega automaticamente unidades de origem e limita quantidade
async function carregarUnidadeOrigem(productId) {
    unitOrigemSelect.innerHTML = '<option value="">-- Selecione --</option>';
    quantidadeInput.value = '';
    quantidadeInput.max = '';

    if (!productId) return;

    const response = await fetch(`/movements/stock/${productId}`);
    const data = await response.json();

    data.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s.unit_id;
        opt.text = `${s.unit_name} (Disponível: ${s.quantidade})`;
        opt.dataset.max = s.quantidade; // guarda a quantidade máxima
        unitOrigemSelect.appendChild(opt);
    });

    // Se só tiver uma unidade, seleciona automaticamente
    if (data.length === 1) {
        unitOrigemSelect.selectedIndex = 1;
        quantidadeInput.max = data[0].quantidade;
    }
}

// Atualiza quantidade máxima quando muda unidade de origem
unitOrigemSelect.addEventListener("change", () => {
    const selected = unitOrigemSelect.options[unitOrigemSelect.selectedIndex];
    quantidadeInput.max = selected?.dataset.max || '';
    quantidadeInput.value = ''; // reseta para evitar ultrapassar o limite
});

// Ao mudar o produto, carrega unidades de origem
productSelect.addEventListener("change", () => {
    carregarUnidadeOrigem(productSelect.value);
});
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Produtos - SIGEIN{% endblock %}

{% block content %}

<div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 20px;">
    <h2>Produtos</h2>
    <a href="/products/add">
        <button class="animated-btn">Cadastrar Novo</button>
    </a>
</div>

<!-- FILTROS -->
<div class="filtros-container">
    <div class="filtro-item">
        <label>Tipo</label>
        <div class="search-container" data-col="3" data-filter="tipo">
            <input type="text" placeholder="Clique para selecionar..." class="filter-search">
            <span class="arrow">â–¼</span>
            <div class="options">
                {% for tipo in tipos %}
                    <div class="option">
                        <input type="checkbox" value="{{ tipo }}">
                        <label>{{ tipo }}</label>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="filtro-item">
        <label>Marca</label>
        <div class="search-container" data-col="4" data-filter="marca">
            <input type="text" placeholder="Clique para selecionar..." class="filter-search">
            <span class="arrow">â–¼</span>
            <div class="options">
                {% for marca in marcas %}
                    <div class="option">
                        <input type="checkbox" value="{{ marca }}">
                        <label>{{ marca }}</label>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="filtro-item">
        <label>Estado</label>
        <div class="search-container" data-col="5" data-filter="estado">
            <input type="text" placeholder="Clique para selecionar..." class="filter-search">
            <span class="arrow">â–¼</span>
            <div class="options">
                {% for estado in estados %}
                    <div class="option">
                        <input type="checkbox" value="{{ estado }}">
                        <label>{{ estado }}</label>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="filtro-item">
        <label>Status</label>
        <div class="search-container" data-col="6" data-filter="status">
            <input type="text" placeholder="Clique para selecionar..." class="filter-search">
            <span class="arrow">â–¼</span>
            <div class="options">
                {% for s in status_list %}
                    <div class="option">
                        <input type="checkbox" value="{{ s }}">
                        <label>{{ s }}</label>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="filtro-item">
        <label>Unidade</label>
        <div class="search-container" data-col="7" data-filter="unidade">
            <input type="text" placeholder="Clique para selecionar..." class="filter-search">
            <span class="arrow">â–¼</span>
            <div class="options">
                {% for u in unidades %}
                    <div class="option">
                        <input type="checkbox" value="{{ u }}">
                        <label>{{ u }}</label>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div style="display:flex; align-items:center; margin-top:18px;">
        <button id="clear-filters" class="clear-btn">ðŸ§¹ Limpar Filtros</button>
    </div>
</div>

<!-- TABELA -->
<div class="table-section">
    <h4>Lista de Produtos</h4>

    <table id="productsTable" class="data-grid display">
        <thead>
            <tr>
                <th><input type="checkbox" id="select-all" onclick="toggleAll(this)"></th>
                <th>ID</th>
                <th>Nome</th>
                <th>Tipo</th>
                <th>Marca</th>
                <th>Estado</th>
                <th>Status</th>
                <th>Unidade</th>
                <th>Tombo/SÃ©rie</th>
                <th>AÃ§Ãµes</th>
            </tr>
        </thead>

        <tbody>
        {% for p in products %}
            <tr>
                <td><input type="checkbox" class="select-item"></td>
                <td>{{ p.id }}</td>
                <td>{{ p.name }}</td>
                <td>{{ p.type.nome if p.type else '-' }}</td>
                <td>{{ p.brand.nome if p.brand else '-' }}</td>

                {# Mostra todos os estados/status de todos os items do produto #}
                <td>
                    {% if p.items %}
                        {{ p.items | map(attribute='estado.nome') | select | join(', ') }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {% if p.items %}
                        {{ p.items | map(attribute='status') | select | join(', ') }}
                    {% else %}
                        -
                    {% endif %}
                </td>

                <td>
                    {% if p.unit %}
                        {{ p.unit.nome }}
                    {% elif p.items %}
                        {{ p.items | map(attribute='unit.nome') | select | join(', ') }}
                    {% else %}
                        -
                    {% endif %}
                </td>

                <td>
                    {% if p.items %}
                        {% set numeros = p.items | map(attribute='num_tombo_ou_serie') | select | list %}
                    {% if numeros %}
                        {{ numeros | join(', ') }}
                    {% else %}
                        <span class="badge-nao">NÃ£o</span>
                    {% endif %}
                    {% else %}
                        <span class="badge-nao">NÃ£o</span>
                    {% endif %}
                </td>

                <td>
                    <a href="/products/edit/{{ p.id }}" title="Editar">
                        <i class="fas fa-pen" style="color:#ffaa00; font-size:18px;"></i></a>
                    
                    <form class="delete-form" data-id="{{ p.id }}" style="display:inline;">
                        <button type="submit" style="background:none; border:none; padding:0; cursor:pointer;">
                        <i class="fas fa-trash" style="color:#cc0000; font-size:18px;"></i>
                        </button>
                    </form>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<style>
    .dataTables_length label {
    display: flex;
    align-items: center;
    gap: 6px; /* espaÃ§o entre texto e select */
}

    .dataTables_length select {
    width: auto;
    display: inline-block;
}
</style>

<!-- LIBS -->
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- CSS -->
<link rel="stylesheet" href="{{ request.url_for('static', path='css/equipamentos-grid.css') }}">

<script>
function toggleAll(source) {
    let checkboxes = document.getElementsByClassName('select-item');
    for (let i = 0; i < checkboxes.length; i++) {
        checkboxes[i].checked = source.checked;
    }
}

$(document).ready(function() {
    var table = $('#productsTable').DataTable({
        order: [[1, "asc"]],
        columnDefs: [
                    { orderable: false, targets: [0,6] },
                    { visible: false, targets: [0,1,2] } // checkbox e ID ocultos
        ],
        language: {
            emptyTable: "Nenhum produto encontrado",
            info: "Mostrando _START_ a _END_ de _TOTAL_",
            infoEmpty: "Mostrando 0 a 0 de 0",
            lengthMenu: "Mostrar registros _MENU_",
            zeroRecords: "Nenhum produto encontrado",
            paginate: {
                first:"Primeiro", last:"Ãšltimo",
                next:"PrÃ³ximo", previous:"Anterior"
            }
        },
        order: [[3, "asc"]],
        pageLength: 10,
        dom: 'rt<"bottom"l<"info-wrapper"ip>><"clear">'
    });

    // FILTROS
    $('.search-container').each(function() {
    const container = $(this);
    const input = container.find('.filter-search');
    const optionsDiv = container.find('.options');
    const arrow = container.find('.arrow');
    const filterType = container.data('filter');
    let selecionados = [];

    function renderOptions(query = '') {
        // âœ… sem lista â€” filtra por texto e mostra tudo se query vazia
        optionsDiv.find('.option').each(function() {
            const val = $(this).find('input').val().toLowerCase();
            $(this).toggle(query === '' || val.includes(query));
        });
        optionsDiv.show();
        arrow.addClass('open');
    }

    input.on("click", function(e) {
        e.stopPropagation();
        $('.search-container').not(container).find('.options').hide()
            .closest('.search-container').find('.arrow').removeClass('open');

        if (optionsDiv.is(":visible")) {
            optionsDiv.hide();
            arrow.removeClass('open');
        } else {
            renderOptions(''); // âœ… abre com todos os itens visÃ­veis
        }
    });

    input.on('input', function() {
        renderOptions(input.val().toLowerCase()); // âœ… filtra pelo que digitou
    });

    optionsDiv.on('change', 'input[type="checkbox"]', function() {
        const val = $(this).val();
        if (this.checked) {
            selecionados.push(val);
        } else {
            selecionados = selecionados.filter(v => v !== val);
        }

        input.val(selecionados.join(', '));

        let colIndex;
        switch(filterType) {
            case "tipo":   colIndex = 3; break;
            case "marca":  colIndex = 4; break;
            case "estado": colIndex = 5; break;
            case "status": colIndex = 6; break;
            case "unidade": colIndex = 7; break;
        }

        const searchValue = selecionados.map(v =>
            // âœ… escapa caracteres especiais para o regex do DataTables
            v.replace(/[-[\]{}()*+?.,\\^$|#\s]/g, '\\$&')
        ).join('|');

        table.column(colIndex)
            .search(selecionados.length ? searchValue : '', true, false)
            .draw();
    });

    $(document).on('click', function(e) {
        if (!$(e.target).closest(container).length) {
            optionsDiv.hide();
            arrow.removeClass('open');
        }
    });

    container.data('reset', function() {
        selecionados = [];
        input.val('');
        // desmarca checkboxes
        optionsDiv.find('input[type="checkbox"]').prop('checked', false);
        const colIdx = container.data('col');
        table.column(colIdx).search('').draw();
        optionsDiv.hide();
        arrow.removeClass('open');
    });
});

$('#clear-filters').on('click', function() {
    $('.search-container').each(function() {
        const resetFn = $(this).data('reset');
        if (typeof resetFn === 'function') resetFn();
    });
});
});
</script>

<script>
    // DELETE MODERNO
$(document).on("submit", ".delete-form", function(e) {
    e.preventDefault();

    const form = $(this);
    const productId = form.data("id");

    Swal.fire({
        title: 'Tem certeza?',
        text: "Essa aÃ§Ã£o nÃ£o poderÃ¡ ser desfeita.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#cc0000',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Sim, excluir',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {

            fetch(`/products/delete/${productId}`, {
                method: "POST"
            })
            .then(response => response.json())
            .then(data => {

                if (data.success) {

                    Swal.fire({
                        icon: 'success',
                        title: 'ExcluÃ­do!',
                        text: 'Produto removido com sucesso.',
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => {
                        location.reload();
                    });

                } else {

                    Swal.fire({
                        icon: 'error',
                        title: 'NÃ£o permitido',
                        text: data.message
                    });

                }

            });
        }
    });
});

</script>

<style>
    /* Garante que o SweetAlert fique acima de tudo */
.swal2-container {
    z-index: 99999 !important;
}
</style>
{% endblock %}
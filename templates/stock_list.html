{% extends "base.html" %}

{% block title %}Estoque{% endblock %}

{% block content %}

<div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 20px;">
    <h2>Estoque</h2>
</div>

<!-- FILTROS -->
<div class="filtros-container">

    {% for label in ["Produto","Unidade","Quantidade","M√≠nimo","S√©rie","Status"] %}
    <div class="filtro-item">
        <label>{{ label }}</label>
        <div class="search-container" data-col="{{ loop.index0 }}">
            <input type="text" placeholder="Clique para selecionar..." class="filter-search">
            <span class="arrow">‚ñº</span>
            <div class="options"></div>
        </div>
    </div>
    {% endfor %}

    <div style="display:flex; align-items:center; margin-top:18px;">
        <button id="clear-filters" class="clear-btn">üßπ Limpar Filtros</button>
    </div>

</div>

<!-- TABELA -->
<div class="table-section">
    <h4>Vis√£o Geral de Estoque</h4>

    <table id="stockTable" class="data-grid display">
        <thead>
            <tr>
                <th>Tipo</th>
                <th>Unidade</th>
                <th>Quantidade</th>
                <th>M√≠nimo</th>
                <th>S√©rie</th>
                <th>Status</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>,

<style>
    .dataTables_length label {
    display: flex;
    align-items: center;
    gap: 6px; /* espa√ßo entre texto e select */
}

    .dataTables_length select {
    width: auto;
    display: inline-block;
}
</style>

<!-- LIBS -->
<script src="https://kit.fontawesome.com/a076d05399.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<!-- CSS -->
<link rel="stylesheet" href="{{ request.url_for('static', path='css/equipamentos-grid.css') }}">

<script>
$(document).ready(function() {

    var table = $('#stockTable').DataTable({
        ajax: {
            url: "/stock/overview",
            dataSrc: ""
        },
        columns: [
    { data: "product_type" }, // <- Agora mostra o tipo do produto
    { data: "unit_name" },
    { data: "quantidade" },
    {
        data: "quantidade_minima",
        render: data => data === null ? '-' : data
    },
    {
        data: "controla_por_serie",
        render: d => d ? 'Sim' : 'N√£o'
    },
    {
        data: "status",
        render: function(data) {
            const cls = data === 'CRITICO' ? 'status-critico' : 'status-ok';
            return `<span class="${cls}">${data}</span>`;
        }
    },
    {
        data: null,
        orderable: false,
        render: function(row) {
            return `
                <a href="/stock/product/${row.product_id}" title="Detalhar">
                    <i class="fas fa-eye"></i>
                </a>
                <a href="/movements/nova?product=${row.product_id}" title="Movimentar">
                    <i class="fas fa-exchange-alt"></i>
                </a>
            `;
        }
    }
],
        order: [[0, "asc"]],
        pageLength: 15,
        language: {
            emptyTable: "Nenhum produto encontrado",
            info: "Mostrando _START_ a _END_ de _TOTAL_",
            infoEmpty: "Mostrando 0 a 0 de 0",
            lengthMenu: "Mostrar registros _MENU_",
            zeroRecords: "Nenhum produto encontrado",
            paginate: {
                first:"Primeiro", last:"√öltimo",
                next:"Pr√≥ximo", previous:"Anterior"
            }
        },
        pageLength: 10,
        dom: 'rt<"bottom"l<"info-wrapper"ip>><"clear">'
    });

    // FILTROS
    $('.search-container').each(function() {
        const container = $(this);
        const input = container.find('.filter-search');
        const optionsDiv = container.find('.options');
        const colIndex = container.data('col');
        const column = table.column(colIndex);
        let selecionados = [];

        function renderOptions(lista) {
            optionsDiv.empty();
            lista.forEach(v => {
                optionsDiv.append(`
                    <div class="option">
                        <input type="checkbox" value="${v}">
                        <label>${v}</label>
                    </div>
                `);
            });
            optionsDiv.show();
        }

        input.on("click", function(e) {
    e.stopPropagation();

    const valores = column.data().unique().sort().toArray();

    // üîπ Fecha todos os outros filtros
    $('.search-container').not(container).each(function() {
        $(this).find('.options').hide();
        $(this).find('.filter-search').removeClass('active');
    });

    // üîπ Alterna o filtro atual
    if (optionsDiv.is(":visible")) {
        optionsDiv.hide();
        input.removeClass('active');
    } else {
        renderOptions(valores);
        input.addClass('active');
    }
});


        optionsDiv.on('change', 'input', function() {
            const val = $(this).val();
            this.checked ? selecionados.push(val) :
                selecionados = selecionados.filter(v => v !== val);

            input.val(selecionados.join(', '));

            selecionados.length
                ? column.search(selecionados.join('|'), true, false).draw()
                : column.search('').draw();
        });

        $(document).on('click', function(e) {
            if (!$(e.target).closest(container).length) {
                optionsDiv.hide();
            }
        });

        container.data('reset', function() {
            selecionados = [];
            input.val('');
            column.search('').draw();
            optionsDiv.hide();
        });
    });

    $('#clear-filters').on('click', function() {
        $('.search-container').each(function() {
            const resetFn = $(this).data('reset');
            if (resetFn) resetFn();
        });
    });

});
</script>

<style>
.status-ok {
    color: #0a8f3c;
    font-weight: bold;
}
.status-critico {
    color: #c00000;
    font-weight: bold;
}
</style>

{% endblock %}

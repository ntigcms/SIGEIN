{% extends "base.html" %}

{% block title %}Estoque{% endblock %}

{% block content %}

<div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 20px;">
    <h2>Estoque</h2>
</div>

<!-- FILTROS -->
<div class="filtros-container">
    {% for label in ["Produto","Unidade","Quantidade","M√≠nimo","Tombo/S√©rie","Status"] %}
    <div class="filtro-item">
        <label>{{ label }}</label>
        <div class="search-container" data-col="{{ loop.index0 }}">
            <input type="text" placeholder="Clique para selecionar..." class="filter-search">
            <span class="arrow">‚ñº</span>
            <div class="options"></div>
        </div>
    </div>
    {% endfor %}

    <div style="display:flex; align-items:center; margin-top:18px;">
        <button id="clear-filters" class="clear-btn">üßπ Limpar Filtros</button>
    </div>
</div>

<!-- TABELA -->
<div class="table-section">
    <h4>Vis√£o Geral de Estoque</h4>

    <table id="stockTable" class="data-grid display">
        <thead>
            <tr>
                <th>Tipo</th>
                <th>Unidade</th>
                <th>Quantidade</th>
                <th>M√≠nimo</th>
                <th>Tombo/S√©rie</th>
                <th>Status</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- MODAL 1: Produto com Tombo/S√©rie -->
<div id="modal-product-details" class="modal-overlay" style="display:none;">
    <div class="modal-container" style="max-width: 900px;">
        <div class="modal-header">
            <h3>Detalhes do Estoque</h3>
            <button class="modal-close" onclick="closeModal('modal-product-details')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="info-row">
                <div class="info-item">
                    <label>Tipo:</label>
                    <span id="detail-tipo"></span>
                </div>
                <div class="info-item">
                    <label>Unidade:</label>
                    <span id="detail-unidade"></span>
                </div>
                <div class="info-item">
                    <label>Quantidade Total:</label>
                    <span id="detail-quantidade"></span>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                <!-- Lista de Tombos -->
                <div class="list-box">
                    <h4>N√∫meros de Tombo (<span id="count-tombo">0</span>)</h4>
                    <div class="scrollable-list" id="lista-tombos">
                        <p class="empty-msg">Nenhum tombo cadastrado</p>
                    </div>
                </div>

                <!-- Lista de S√©ries -->
                <div class="list-box">
                    <h4>N√∫meros de S√©rie (<span id="count-serie">0</span>)</h4>
                    <div class="scrollable-list" id="lista-series">
                        <p class="empty-msg">Nenhuma s√©rie cadastrada</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL 2: Visualiza√ß√£o de Produto (readonly) -->
<div id="modal-product-view" class="modal-overlay" style="display:none;">
    <div class="modal-container" style="max-width: 700px;">
        <div class="modal-header">
            <h3>Visualiza√ß√£o do Produto</h3>
            <button class="modal-close" onclick="closeModal('modal-product-view')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group-row">
                <div class="form-group">
                    <label>Tipo:</label>
                    <input type="text" id="view-tipo" readonly>
                </div>
                <div class="form-group">
                    <label>Marca:</label>
                    <input type="text" id="view-marca" readonly>
                </div>
            </div>
            <div class="form-group-row">
                <div class="form-group">
                    <label>Modelo:</label>
                    <input type="text" id="view-modelo" readonly>
                </div>
                <div class="form-group">
                    <label>Estado:</label>
                    <input type="text" id="view-estado" readonly>
                </div>
            </div>
            <div class="form-group-row">
                <div class="form-group">
                    <label>Status:</label>
                    <input type="text" id="view-status" readonly>
                </div>
                <div class="form-group">
                    <label>Unidade:</label>
                    <input type="text" id="view-unidade" readonly>
                </div>
            </div>
            <div class="form-group-row">
                <div class="form-group">
                    <label id="label-quantidade">Quantidade:</label>
                    <input type="text" id="view-quantidade" readonly>
                </div>
                <div class="form-group" id="numero-container" style="display:none;">
                    <label>Tombo/S√©rie:</label>
                    <input type="text" id="view-numero" readonly>
                </div>
            </div>
            <div class="form-group">
                <label>Observa√ß√£o:</label>
                <textarea id="view-observacao" readonly rows="3"></textarea>
            </div>

            <!-- ‚úÖ Bot√£o Voltar -->
            <div style="display: flex; justify-content: flex-end; margin-top: 20px; gap: 10px;">
                <button onclick="voltarParaDetalhes()" class="btn-voltar" id="btn-voltar-detalhes" style="display:none;">
                    ‚Üê Voltar
                </button>
                <button onclick="closeModal('modal-product-view')" class="btn-fechar">
                    Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- LIBS -->
<script src="https://kit.fontawesome.com/a076d05399.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<!-- CSS -->
<link rel="stylesheet" href="{{ request.url_for('static', path='css/equipamentos-grid.css') }}">

<style>
.dataTables_length label {
    display: flex;
    align-items: center;
    gap: 6px;
}

.dataTables_length select {
    width: auto;
    display: inline-block;
}

.status-ok {
    color: #0a8f3c;
    font-weight: bold;
}
.status-critico {
    color: #c00000;
    font-weight: bold;
}

/* Modais */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
}

.modal-container {
    background: #fff;
    border-radius: 12px;
    width: 90%;
    max-height: 85vh;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
}

.modal-header {
    background: #0d6efd;
    color: #fff;
    padding: 16px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    font-size: 18px;
}

.modal-close {
    background: none;
    border: none;
    color: #fff;
    font-size: 28px;
    cursor: pointer;
    line-height: 1;
    padding: 0;
    width: 32px;
    height: 32px;
}

.modal-close:hover {
    opacity: 0.8;
}

.modal-body {
    padding: 24px;
    max-height: calc(85vh - 70px);
    overflow-y: auto;
}

/* Info Row */
.info-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 15px;
}

.info-item label {
    font-weight: 600;
    color: #004080;
    font-size: 13px;
    display: block;
    margin-bottom: 4px;
}

.info-item span {
    font-size: 15px;
    color: #333;
}

/* List Boxes */
.list-box {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    background: #fafafa;
}

.list-box h4 {
    margin: 0 0 12px 0;
    font-size: 15px;
    color: #0d6efd;
    font-weight: 600;
}

.scrollable-list {
    max-height: 320px;
    overflow-y: auto;
    padding: 8px;
    background: #fff;
    border-radius: 6px;
    border: 1px solid #e0e0e0;
}

.list-item {
    padding: 10px 12px;
    margin-bottom: 6px;
    background: #f8f9fa;
    border-radius: 6px;
    border-left: 3px solid #0d6efd;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 14px;
    color: #004080;
    text-decoration: none;
    display: block;
}

.list-item:hover {
    background: #e7f3ff;
    transform: translateX(4px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.empty-msg {
    text-align: center;
    color: #999;
    padding: 20px;
    font-size: 14px;
    margin: 0;
}

/* Form Groups */
.form-group-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 15px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    font-size: 13px;
    font-weight: 600;
    color: #004080;
    margin-bottom: 5px;
}

.form-group input,
.form-group textarea {
    padding: 8px 12px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 14px;
    background: #f5f5f5;
}

.form-group input[readonly],
.form-group textarea[readonly] {
    cursor: not-allowed;
    color: #666;
}

/* Bot√µes da modal */
.btn-voltar,
.btn-fechar {
    padding: 10px 20px;
    border-radius: 6px;
    border: none;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-voltar {
    background: #6c757d;
    color: #fff;
}

.btn-voltar:hover {
    background: #5a6268;
}

.btn-fechar {
    background: #0d6efd;
    color: #fff;
}

.btn-fechar:hover {
    background: #0b5ed7;
}
</style>

<script>
// Fun√ß√µes globais para controle de modais
function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// Fecha modal ao clicar fora
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal-overlay')) {
        e.target.style.display = 'none';
    }
});

// ‚úÖ Para produtos SEM s√©rie
async function openStockDetails(typeId, unitName) {
    try {
        const response = await fetch(`/stock/items-by-type?type_id=${typeId}&unit_name=${encodeURIComponent(unitName)}`);
        const data = await response.json();

        if (data.controla_por_serie) {
            openProductDetails(typeId, unitName);
            return;
        }

        const stockDaUnidade = data.stock.find(s => s.unit === unitName);

        if (!stockDaUnidade) {
            alert('Estoque n√£o encontrado para esta unidade');
            return;
        }

        document.getElementById('view-tipo').value = data.product_type || '-';
        document.getElementById('view-marca').value = data.product_brand || '-';
        document.getElementById('view-modelo').value = data.product_model || '-';
        document.getElementById('view-estado').value = '-';
        
        const status = stockDaUnidade.quantidade > (stockDaUnidade.minimo || 0) ? 'OK' : 'CR√çTICO';
        document.getElementById('view-status').value = status;
        
        document.getElementById('view-unidade').value = stockDaUnidade.unit;
        document.getElementById('view-quantidade').value = `${stockDaUnidade.quantidade} (M√≠nimo: ${stockDaUnidade.minimo || 0})`;
        document.getElementById('numero-container').style.display = 'none';
        
        document.getElementById('view-observacao').value = 'Produto controlado por quantidade (sem tombo/s√©rie individual)';

        document.getElementById('modal-product-view').style.display = 'flex';

    } catch (error) {
        console.error('Erro ao carregar estoque:', error);
        alert('Erro ao carregar informa√ß√µes de estoque');
    }
}


// Abre modal de detalhes (produtos com tombo/s√©rie)
async function openProductDetails(typeId, unitName) {
    try {
        // ‚úÖ Salva o contexto
        currentTypeId = typeId;
        currentUnitName = unitName;

        const response = await fetch(`/stock/items-by-type?type_id=${typeId}&unit_name=${encodeURIComponent(unitName)}`);
        const data = await response.json();

        if (!data.controla_por_serie) {
            alert('Este tipo de produto n√£o controla por tombo/s√©rie');
            return;
        }

        const tombos = data.items.filter(i => i.tombo === true);
        const series = data.items.filter(i => i.tombo === false);

        document.getElementById('detail-tipo').textContent = data.product_type || '-';
        document.getElementById('detail-unidade').textContent = unitName;
        document.getElementById('detail-quantidade').textContent = data.items.length;

        const listaTombos = document.getElementById('lista-tombos');
        document.getElementById('count-tombo').textContent = tombos.length;
        
        if (tombos.length > 0) {
            listaTombos.innerHTML = tombos.map(t => 
                `<a href="#" class="list-item" onclick="openItemView(${t.id}); return false;">${t.num}</a>`
            ).join('');
        } else {
            listaTombos.innerHTML = '<p class="empty-msg">Nenhum tombo cadastrado</p>';
        }

        const listaSeries = document.getElementById('lista-series');
        document.getElementById('count-serie').textContent = series.length;
        
        if (series.length > 0) {
            listaSeries.innerHTML = series.map(s => 
                `<a href="#" class="list-item" onclick="openItemView(${s.id}); return false;">${s.num}</a>`
            ).join('');
        } else {
            listaSeries.innerHTML = '<p class="empty-msg">Nenhuma s√©rie cadastrada</p>';
        }

        document.getElementById('modal-product-details').style.display = 'flex';

    } catch (error) {
        console.error('Erro ao carregar detalhes:', error);
        alert('Erro ao carregar informa√ß√µes do produto');
    }
}

// ‚úÖ Para produtos COM s√©rie (quando clica no n√∫mero da lista)
// ‚úÖ Vari√°veis globais para guardar contexto
let currentTypeId = null;
let currentUnitName = null;

async function openItemView(itemId) {
    try {
        const response = await fetch(`/stock/item/${itemId}`);
        const data = await response.json();

        if (data.error) {
            alert(data.error);
            return;
        }

        // Preenche campos
        document.getElementById('view-tipo').value = data.tipo || '';
        document.getElementById('view-marca').value = data.marca || '';
        document.getElementById('view-modelo').value = data.modelo || '';
        document.getElementById('view-estado').value = data.estado || '';
        document.getElementById('view-status').value = data.status || '';
        document.getElementById('view-unidade').value = data.unidade || '';
        
        // Mostra campo Tombo/S√©rie (n√£o Quantidade)
        document.getElementById('view-quantidade').value = '-';
        document.getElementById('numero-container').style.display = 'block';
        document.getElementById('view-numero').value = data.numero || '';
        
        document.getElementById('view-observacao').value = data.observacao || '';

        // ‚úÖ Mostra bot√£o Voltar se veio da modal de detalhes
        if (currentTypeId && currentUnitName) {
            document.getElementById('btn-voltar-detalhes').style.display = 'block';
        } else {
            document.getElementById('btn-voltar-detalhes').style.display = 'none';
        }

        // Fecha modal de detalhes se estiver aberta
        closeModal('modal-product-details');
        
        document.getElementById('modal-product-view').style.display = 'flex';

    } catch (error) {
        console.error('Erro ao carregar item:', error);
        alert('Erro ao carregar informa√ß√µes do item');
    }
}

// ‚úÖ Fun√ß√£o para voltar √† modal de detalhes
function voltarParaDetalhes() {
    closeModal('modal-product-view');
    if (currentTypeId && currentUnitName) {
        openProductDetails(currentTypeId, currentUnitName);
    }
}

$(document).ready(function() {

    var table = $('#stockTable').DataTable({
        ajax: {
            url: "/stock/overview",
            dataSrc: ""
        },
        columns: [
            { data: "product_type" },
            { data: "unit_name" },
            { data: "quantidade" },
            {
                data: "quantidade_minima",
                render: data => data === null ? '-' : data
            },
            {
                data: "controla_por_serie",
                render: d => d ? 'Sim' : 'N√£o'
            },
            {
                data: "status",
                render: function(data) {
                    const cls = data === 'CRITICO' ? 'status-critico' : 'status-ok';
                    return `<span class="${cls}">${data}</span>`;
                }
            },
            {
    data: null,
    orderable: false,
    render: function(row) {
        if (row.controla_por_serie) {
            return `
                <a href="#" onclick="openProductDetails(${row.type_id}, '${row.unit_name}'); return false;" title="Detalhar">
                    <i class="fas fa-eye"></i></a>
                <a href="/movements/nova?type=${row.type_id}" title="Movimentar">
                    <i class="fas fa-exchange-alt"></i>
                </a>
            `;
        } else {
            return `
                <a href="#" onclick="openStockDetails(${row.type_id}, '${row.unit_name}'); return false;" title="Detalhar">
                    <i class="fas fa-eye"></i></a>
                <a href="/movements/nova?type=${row.type_id}" title="Movimentar">
                    <i class="fas fa-exchange-alt"></i>
                </a>
            `;
        }
    }
}
        ],
        order: [[0, "asc"]],
        pageLength: 10,
        language: {
            emptyTable: "Nenhum produto encontrado",
            info: "Mostrando _START_ a _END_ de _TOTAL_",
            infoEmpty: "Mostrando 0 a 0 de 0",
            lengthMenu: "Mostrar registros _MENU_",
            zeroRecords: "Nenhum produto encontrado",
            paginate: {
                first:"Primeiro", last:"√öltimo",
                next:"Pr√≥ximo", previous:"Anterior"
            }
        },
        dom: 'rt<"bottom"l<"info-wrapper"ip>><"clear">'
    });

    // FILTROS
    table.on('init', function() {

        $('.search-container').each(function() {
            const container = $(this);
            const input = container.find('.filter-search');
            const optionsDiv = container.find('.options');
            const colIndex = container.data('col');
            const column = table.column(colIndex);
            let selecionados = [];
            let valoresOriginais = [];

            function getValores() {
                let valores = column.data().unique().toArray().map(v => {
                    if (colIndex === 4) return v ? 'Sim' : 'N√£o';
                    return String(v ?? '').replace(/<[^>]+>/g, '').trim();
                });
                return [...new Set(valores)].filter(Boolean).sort();
            }

            function renderOptions(lista) {
                optionsDiv.empty();
                lista.forEach(v => {
                    const checked = selecionados.includes(v) ? 'checked' : '';
                    optionsDiv.append(`
                        <div class="option">
                            <input type="checkbox" value="${v}" ${checked}>
                            <label>${v}</label>
                        </div>
                    `);
                });
                optionsDiv.show();
            }

            input.on("click", function(e) {
                e.stopPropagation();
                $('.search-container').not(container).find('.options').hide();

                if (optionsDiv.is(":visible")) {
                    optionsDiv.hide();
                } else {
                    valoresOriginais = getValores();
                    renderOptions(valoresOriginais);
                }
            });

            input.on('input', function() {
                if (!valoresOriginais.length) {
                    valoresOriginais = getValores();
                }
                const termo = input.val().toLowerCase();
                const filtrados = valoresOriginais.filter(v =>
                    v.toLowerCase().includes(termo)
                );
                renderOptions(filtrados);
            });

            optionsDiv.on('change', 'input[type="checkbox"]', function() {
                const val = $(this).val();
                if (this.checked) {
                    selecionados.push(val);
                } else {
                    selecionados = selecionados.filter(v => v !== val);
                }

                input.val(selecionados.join(', '));

                const searchValue = selecionados
                    .map(v => v.replace(/[-[\]{}()*+?.,\\^$|#\s]/g, '\\$&'))
                    .join('|');

                column.search(selecionados.length ? searchValue : '', true, false).draw();
            });

            $(document).on('click', function(e) {
                if (!$(e.target).closest(container).length) {
                    optionsDiv.hide();
                }
            });

            container.data('reset', function() {
                selecionados = [];
                valoresOriginais = [];
                input.val('');
                column.search('').draw();
                optionsDiv.hide();
            });
        });

    });

    $('#clear-filters').on('click', function() {
        $('.search-container').each(function() {
            const resetFn = $(this).data('reset');
            if (typeof resetFn === 'function') resetFn();
        });
    });

});
</script>

{% endblock %}
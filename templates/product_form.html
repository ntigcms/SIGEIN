{% extends "base.html" %}
{% block title %}{{ 'Editar' if action == 'edit' else 'Cadastrar' }} Produto{% endblock %}

{% block content %}
<div class="container">
    <h2>{{ 'Editar' if action == 'edit' else 'Cadastrar' }} Produto</h2>

    <form method="post" id="product-form">
        
        <!-- DADOS B√ÅSICOS DO PRODUTO -->
<fieldset>
    <legend>Dados Gerais</legend>
    
    <div class="form-row">
    <div class="form-group">
        <label for="category_id">Categoria*</label>
        <select name="category_id" id="category_id" required onchange="carregarTipos()">
            <option value="">-- Selecione --</option>
            {% for cat in categories %}
                <option value="{{ cat.id }}" {% if product and product.category_id == cat.id %}selected{% endif %}>
                    {{ cat.nome }}
                </option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label for="type_id">Tipo*</label>
        <select name="type_id" id="type_id" required disabled>
            <option value="">-- Selecione a categoria primeiro --</option>
        </select>
    </div>
</div>

    <div class="form-row">
        <div class="form-group">
            <label for="brand_id">Marca*</label>
            <select name="brand_id" required>
                <option value="">-- Selecione --</option>
                {% for marca in marcas %}
                    <option value="{{ marca.id }}" {% if product and product.brand_id == marca.id %}selected{% endif %}>
                        {{ marca.nome }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="model">Modelo</label>
            <input type="text" name="model" value="{{ product.model if product else '' }}">
        </div>
    </div>

    <div class="form-group">
        <label for="description">Descri√ß√£o</label>
        <input type="text" name="description" required value="{{ product.description if product else '' }}">
    </div>

    <div class="form-group">
        <label>
            <input type="checkbox" name="controla_por_serie" id="controla_por_serie" 
                   {% if product and product.controla_por_serie %}checked{% endif %}
                   onchange="toggleControles()">
            Controla por Tombo/S√©rie
        </label>
    </div>
</fieldset>

        <!-- SE√á√ÉO: PRODUTOS SEM S√âRIE (QUANTIDADE) -->
        <fieldset id="secao-sem-serie" style="display:none;">
            <legend>Controle de Quantidade</legend>

            {% if is_master and action == 'add' %}
            <div class="form-row" id="row-lotacao-sem-serie">
                <div class="form-group">
                    <label for="lotacao_estado">Estado*</label>
                    <select id="lotacao_estado" onchange="carregarMunicipiosLotacao('sem-serie')">
                        <option value="">-- Selecione --</option>
                        {% for e in estados_geograficos %}
                            <option value="{{ e.id }}">{{ e.nome }} ({{ e.uf }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="lotacao_municipio">Munic√≠pio*</label>
                    <select id="lotacao_municipio_sem_serie" disabled onchange="carregarOrgaosLotacao('sem-serie')">
                        <option value="">-- Selecione o Estado --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="lotacao_orgao">√ìrg√£o*</label>
                    <select id="lotacao_orgao_sem_serie" disabled onchange="carregarUnidadesLotacao('sem-serie')">
                        <option value="">-- Selecione o Munic√≠pio --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="unit_id">Unidade*</label>
                    <select name="unit_id" id="unit_id_sem_serie" disabled required>
                        <option value="">-- Selecione o √ìrg√£o --</option>
                    </select>
                </div>
            </div>
            {% else %}
            {% if lotacao %}
            <div class="form-row lotacao-readonly">
                <div class="form-group"><label>Estado</label><span>{{ lotacao.estado }}</span></div>
                <div class="form-group"><label>Munic√≠pio</label><span>{{ lotacao.municipio }}</span></div>
                <div class="form-group"><label>√ìrg√£o</label><span>{{ lotacao.orgao }}</span></div>
                <div class="form-group"><label>Unidade</label><span>{{ lotacao.unidade }}</span></div>
            </div>
            {% endif %}
            <div class="form-row">
                <div class="form-group">
                    <label for="unit_id">Unidade*</label>
                    <select name="unit_id" id="unit_id">
                        <option value="">-- Selecione --</option>
                        {% for u in units %}
                            <option value="{{ u.id }}" {% if default_unidade_id and default_unidade_id == u.id %}selected{% endif %}>{{ u.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="quantidade">Quantidade</label>
                    <input type="number" name="quantidade" min="0" value="{{ product.quantidade if product else (item.quantidade if item else 0) }}">
                </div>
                <div class="form-group">
                    <label for="quantidade_minima">Quantidade M√≠nima</label>
                    <input type="number" name="quantidade_minima" min="0" value="{{ product.quantidade_minima if product else (item.quantidade_minima if item else 0) }}">
                </div>
            </div>
            {% endif %}

            {% if is_master and action == 'add' %}
            <div class="form-row">
                <div class="form-group">
                    <label for="quantidade">Quantidade</label>
                    <input type="number" name="quantidade" id="quantidade" min="0" value="{{ product.quantidade if product else (item.quantidade if item else 0) }}">
                </div>
                <div class="form-group">
                    <label for="quantidade_minima">Quantidade M√≠nima</label>
                    <input type="number" name="quantidade_minima" min="0" value="{{ product.quantidade_minima if product else (item.quantidade_minima if item else 0) }}">
                </div>
            </div>
            {% endif %}
        </fieldset>

        <!-- SE√á√ÉO: PRODUTOS COM S√âRIE (CADASTRO EM LOTE) -->
        <fieldset id="secao-com-serie" style="display:none;">
            <legend>Tombos/S√©ries</legend>

            {% if is_master and action == 'add' %}
            <div class="form-row" id="row-lotacao-serie">
                <div class="form-group">
                    <label for="lotacao_estado_serie">Estado*</label>
                    <select id="lotacao_estado_serie" onchange="carregarMunicipiosLotacao('serie')">
                        <option value="">-- Selecione --</option>
                        {% for e in estados_geograficos %}
                            <option value="{{ e.id }}">{{ e.nome }} ({{ e.uf }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="lotacao_municipio_serie">Munic√≠pio*</label>
                    <select id="lotacao_municipio_serie" disabled onchange="carregarOrgaosLotacao('serie')">
                        <option value="">-- Selecione o Estado --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="lotacao_orgao_serie">√ìrg√£o*</label>
                    <select id="lotacao_orgao_serie" disabled onchange="carregarUnidadesLotacao('serie')">
                        <option value="">-- Selecione o Munic√≠pio --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="unit_id_serie">Unidade*</label>
                    <select name="unit_id_serie" id="unit_id_serie" disabled required>
                        <option value="">-- Selecione o √ìrg√£o --</option>
                    </select>
                </div>
            </div>
            {% else %}
            <div class="form-row">
                <div class="form-group">
                    <label for="unit_id_serie">Unidade*</label>
                    <select name="unit_id_serie" id="unit_id_serie">
                        <option value="">-- Selecione --</option>
                        {% for u in units %}
                            <option value="{{ u.id }}" {% if default_unidade_id and default_unidade_id == u.id %}selected{% endif %}>{{ u.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            {% endif %}

            <div class="form-row">
                <div class="form-group">
                    <label for="estado_id">Estado (f√≠sico)</label>
                    <select name="estado_id" id="estado_id">
                        <option value="">-- Selecione --</option>
                        {% for estado in estados %}
                            <option value="{{ estado.id }}" {% if item and item.estado_id == estado.id %}selected{% endif %}>{{ estado.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="status">Status</label>
                    <select name="status" id="status">
                        <option value="Dispon√≠vel" {% if item and item.status == 'Dispon√≠vel' %}selected{% endif %}>Dispon√≠vel</option>
                        <option value="Em Uso" {% if item and item.status == 'Em Uso' %}selected{% endif %}>Em Uso</option>
                        <option value="Manuten√ß√£o" {% if item and item.status == 'Manuten√ß√£o' %}selected{% endif %}>Manuten√ß√£o</option>
                        <option value="Bloqueado" {% if item and item.status == 'Bloqueado' %}selected{% endif %}>Bloqueado</option>
                    </select>
                </div>
            </div>

            <!-- ‚úÖ LISTA DE TOMBOS/S√âRIES -->
            <div id="lista-numeros">
                <!-- Primeiro item sempre vis√≠vel -->
                <div class="numero-item" data-index="0">
                    <div class="form-row">
                        <div class="form-group" style="flex: 0 0 150px;">
                            <label>Tipo*</label>
                            <select name="tipo_numero[]" class="tipo-numero" onchange="toggleCampoNumero(this)">
                                <option value="tombo">Tombo</option>
                                <option value="serie">S√©rie</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="label-numero">N√∫mero do Tombo*</label>
                            <input type="text" name="numero[]" class="input-numero" required placeholder="Digite o n√∫mero">
                        </div>
                        <div class="form-group" style="flex: 0 0 100px; align-self: flex-end;">
                            <button type="button" class="btn-remove" onclick="removerNumero(this)" style="display:none;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <button type="button" class="btn-add-numero" onclick="adicionarNumero()">
                <i class="fas fa-plus"></i> Adicionar Novo Tombo/S√©rie
            </button>
        </fieldset>

        <!-- DADOS ADICIONAIS (comuns para ambos) -->
        <fieldset>
            <legend>Informa√ß√µes Adicionais</legend>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="data_aquisicao">Data de Aquisi√ß√£o</label>
                    <input type="date" name="data_aquisicao" id="data_aquisicao"
                           value="{{ item.data_aquisicao if item and item.data_aquisicao else '' }}">
                </div>

                <div class="form-group">
                    <label>Valor</label>
                    <input type="text" name="valor_aquisicao" id="valor_aquisicao" placeholder="R$ 0,00"
                    value="{{ 'R$ {:,.2f}'.format(item.valor_aquisicao).replace(',', 'X').replace('.', ',').replace('X', '.') if item and item.valor_aquisicao }}">
                </div>

                <div class="form-group">
                    <label for="garantia_ate">Garantia at√©</label>
                    <input type="date" name="garantia_ate" id="garantia_ate"
                           value="{{ item.garantia_ate if item and item.garantia_ate else '' }}">
                </div>
            </div>

            <div class="form-group">
                <label for="observacao">Observa√ß√£o</label>
                <textarea name="observacao" required id="observacao" rows="3">{{ item.observacao if item else '' }}</textarea>
            </div>
        </fieldset>

        <div class="buttons">
            <button type="submit" class="btn-submit">{{ 'Atualizar' if action == 'edit' else 'Salvar' }}</button>
            <a href="/products" class="btn-cancel">Cancelar</a>
        </div>
    </form>
</div>

<style>
fieldset {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    background: #fafafa;
}

legend {
    font-weight: 600;
    color: #0d6efd;
    padding: 0 10px;
    font-size: 16px;
}

.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    font-size: 13px;
    font-weight: 600;
    color: #004080;
    margin-bottom: 5px;
}

.lotacao-readonly { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; }
.lotacao-readonly .form-group span { font-weight: 500; color: #0d6efd; margin-left: 4px; }

.form-group input,
.form-group select,
.form-group textarea {
    padding: 8px 12px;
    border: 1px solid #aaa;
    border-radius: 6px;
    font-size: 14px;
}

/* Lista de n√∫meros */
#lista-numeros {
    margin-bottom: 15px;
}

.numero-item {
    padding: 15px;
    background: #fff;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    margin-bottom: 10px;
}

.btn-add-numero {
    background: #28a745;
    color: #fff;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
}

.btn-add-numero:hover {
    background: #218838;
}

.btn-remove {
    background: #dc3545;
    color: #fff;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    width: 100%;
}

.btn-remove:hover {
    background: #c82333;
}

.btn-submit {
    background: #0d6efd;
    color: #fff;
    border: none;
    padding: 12px 30px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
}

.btn-submit:hover {
    background: #0b5ed7;
}

.btn-cancel {
    padding: 11px 24px;
    border-radius: 8px;
    border: 1px solid #cbd5e1;
    color: #334155;
    text-decoration: none;
    display: inline-block;
}

.btn-cancel:hover {
    background: #f1f5f9;
}

.buttons {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}
</style>

<script>
let numeroIndex = 1;

function toggleControles() {
    const controlaSerie = document.getElementById('controla_por_serie').checked;

    const secaoSemSerie = document.getElementById('secao-sem-serie');
    const secaoComSerie = document.getElementById('secao-com-serie');

    secaoSemSerie.style.display = controlaSerie ? 'none' : 'block';
    secaoComSerie.style.display = controlaSerie ? 'block' : 'none';

    // üî• DESABILITA CAMPOS DA SE√á√ÉO OCULTA
    secaoSemSerie.querySelectorAll('select, input').forEach(el => {
        el.disabled = controlaSerie;
    });

    secaoComSerie.querySelectorAll('select, input').forEach(el => {
        el.disabled = !controlaSerie;
    });
}

function toggleCampoNumero(select) {
    const item = select.closest('.numero-item');
    const label = item.querySelector('.label-numero');
    const input = item.querySelector('.input-numero');
    
    if (select.value === 'tombo') {
        label.textContent = 'N√∫mero do Tombo*';
        input.placeholder = 'Digite o n√∫mero do tombo';
    } else {
        label.textContent = 'N√∫mero de S√©rie*';
        input.placeholder = 'Digite o n√∫mero de s√©rie';
    }
}

function adicionarNumero() {
    const container = document.getElementById('lista-numeros');
    const novoItem = document.createElement('div');
    novoItem.className = 'numero-item';
    novoItem.dataset.index = numeroIndex;
    
    novoItem.innerHTML = `
        <div class="form-row">
            <div class="form-group" style="flex: 0 0 150px;">
                <label>Tipo*</label>
                <select name="tipo_numero[]" class="tipo-numero" onchange="toggleCampoNumero(this)">
                    <option value="tombo">Tombo</option>
                    <option value="serie">S√©rie</option>
                </select>
            </div>
            <div class="form-group" style="flex: 1;">
                <label class="label-numero">N√∫mero do Tombo*</label>
                <input type="text" name="numero[]" class="input-numero" required placeholder="Digite o n√∫mero">
            </div>
            <div class="form-group" style="flex: 0 0 100px; align-self: flex-end;">
                <button type="button" class="btn-remove" onclick="removerNumero(this)">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    
    container.appendChild(novoItem);
    numeroIndex++;
    
    // Mostra bot√£o de remover no primeiro item se tiver mais de 1
    if (container.children.length > 1) {
        container.querySelector('.btn-remove').style.display = 'inline-block';
    }
}

async function carregarTipos() {
    const categoryId = document.getElementById('category_id').value;
    const typeSelect = document.getElementById('type_id');
    
    // Limpa e desabilita se n√£o tiver categoria
    if (!categoryId) {
        typeSelect.innerHTML = '<option value="">-- Selecione a categoria primeiro --</option>';
        typeSelect.disabled = true;
        return;
    }
    
    try {
        // Busca tipos da categoria selecionada
        const response = await fetch(`/products/tipos-por-categoria/${categoryId}`);
        const tipos = await response.json();
        
        // Limpa o select
        typeSelect.innerHTML = '<option value="">-- Selecione --</option>';
        
        // Preenche com os tipos da categoria
        tipos.forEach(tipo => {
            const option = document.createElement('option');
            option.value = tipo.id;
            option.textContent = tipo.nome;
            typeSelect.appendChild(option);
        });
        
        // Habilita o campo
        typeSelect.disabled = false;
        
    } catch (error) {
        console.error('Erro ao carregar tipos:', error);
        typeSelect.innerHTML = '<option value="">Erro ao carregar tipos</option>';
    }
}

// ---------- Lota√ß√£o em cascata (perfil Master) ----------
const LOTACAO_IDS = {
    'sem-serie': {
        estado: 'lotacao_estado',
        municipio: 'lotacao_municipio_sem_serie',
        orgao: 'lotacao_orgao_sem_serie',
        unidade: 'unit_id_sem_serie'
    },
    'serie': {
        estado: 'lotacao_estado_serie',
        municipio: 'lotacao_municipio_serie',
        orgao: 'lotacao_orgao_serie',
        unidade: 'unit_id_serie'
    }
};

async function carregarMunicipiosLotacao(section) {
    const ids = LOTACAO_IDS[section];
    if (!ids) return;
    const estadoId = document.getElementById(ids.estado).value;
    const munSelect = document.getElementById(ids.municipio);
    const orgaoSelect = document.getElementById(ids.orgao);
    const unidadeSelect = document.getElementById(ids.unidade);
    munSelect.innerHTML = '<option value="">-- Selecione o Estado --</option>';
    munSelect.disabled = true;
    orgaoSelect.innerHTML = '<option value="">-- Selecione o Munic√≠pio --</option>';
    orgaoSelect.disabled = true;
    unidadeSelect.innerHTML = '<option value="">-- Selecione o √ìrg√£o --</option>';
    unidadeSelect.disabled = true;
    if (!estadoId) return;
    try {
        const r = await fetch(`/api/municipios/${estadoId}`);
        const list = await r.json();
        list.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m.id;
            opt.textContent = m.nome;
            munSelect.appendChild(opt);
        });
        munSelect.disabled = false;
    } catch (e) { console.error(e); }
}

async function carregarOrgaosLotacao(section) {
    const ids = LOTACAO_IDS[section];
    if (!ids) return;
    const municipioId = document.getElementById(ids.municipio).value;
    const orgaoSelect = document.getElementById(ids.orgao);
    const unidadeSelect = document.getElementById(ids.unidade);
    orgaoSelect.innerHTML = '<option value="">-- Selecione o Munic√≠pio --</option>';
    orgaoSelect.disabled = true;
    unidadeSelect.innerHTML = '<option value="">-- Selecione o √ìrg√£o --</option>';
    unidadeSelect.disabled = true;
    if (!municipioId) return;
    try {
        const r = await fetch(`/api/orgaos/${municipioId}`);
        const list = await r.json();
        list.forEach(o => {
            const opt = document.createElement('option');
            opt.value = o.id;
            opt.textContent = o.sigla ? `${o.nome} (${o.sigla})` : o.nome;
            orgaoSelect.appendChild(opt);
        });
        orgaoSelect.disabled = false;
    } catch (e) { console.error(e); }
}

async function carregarUnidadesLotacao(section) {
    const ids = LOTACAO_IDS[section];
    if (!ids) return;
    const orgaoId = document.getElementById(ids.orgao).value;
    const unidadeSelect = document.getElementById(ids.unidade);
    unidadeSelect.innerHTML = '<option value="">-- Selecione o √ìrg√£o --</option>';
    unidadeSelect.disabled = true;
    if (!orgaoId) return;
    try {
        const r = await fetch(`/api/unidades/${orgaoId}`);
        const list = await r.json();
        list.forEach(u => {
            const opt = document.createElement('option');
            opt.value = u.id;
            opt.textContent = u.sigla ? `${u.nome} (${u.sigla})` : u.nome;
            unidadeSelect.appendChild(opt);
        });
        unidadeSelect.disabled = false;
    } catch (e) { console.error(e); }
}

// ‚úÖ Carrega tipos ao abrir a p√°gina (modo edi√ß√£o)
document.addEventListener('DOMContentLoaded', function() {
    const categoryId = document.getElementById('category_id').value;
    if (categoryId) {
        carregarTipos();
    }
    toggleControles();
});

function removerNumero(btn) {
    const container = document.getElementById('lista-numeros');
    btn.closest('.numero-item').remove();
    
    // Esconde bot√£o de remover no primeiro item se s√≥ sobrou 1
    if (container.children.length === 1) {
        container.querySelector('.btn-remove').style.display = 'none';
    }
}

// Inicializa ao carregar
document.addEventListener('DOMContentLoaded', function() {
    toggleControles();
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const input = document.getElementById("valor_aquisicao");
    if (!input) return;

    const formatter = new Intl.NumberFormat("pt-BR", {
        style: "currency",
        currency: "BRL"
    });

    function formatarDireitaParaEsquerda(valor) {
        // mant√©m apenas n√∫meros
        const numeros = valor.replace(/\D/g, "");

        // converte centavos
        const numero = (Number(numeros) / 100).toFixed(2);

        return formatter.format(numero);
    }

    input.addEventListener("input", function () {
        input.value = formatarDireitaParaEsquerda(input.value);
    });

    // Remove m√°scara antes de enviar
    input.form.addEventListener("submit", function () {
        input.value = input.value
            .replace(/\./g, "")
            .replace(",", ".")
            .replace("R$", "")
            .trim();
    });
});
</script>

<script src="https://kit.fontawesome.com/a076d05399.js"></script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Cadastro de Produto / Item{% endblock %}

{% block content %}
<div class="container">
    <h2 style="text-align:center; margin-bottom:25px;">
        {% if action == 'add' %}Adicionar Produto / Item{% else %}Editar Produto / Item{% endif %}
    </h2>

    <form id="inventoryForm" method="POST"
          action="{% if action == 'add' %}/products/add{% else %}/products/edit/{{ product.id }}{% endif %}"
          class="inventory-form">

        <!-- === PRODUTO === -->
        <fieldset class="fieldset-section">
            <legend>Informações do Produto</legend>
            <div class="form-grid">

                <!-- Nome do Produto -->
                <div class="form-group">
                    <label for="product_name">Nome do Produto *</label>
                    <input type="text" id="product_name" name="name"
                           value="{{ product.name if product else '' }}" required
                           title="Ex: Notebook Dell Latitude 5420">
                </div>

                <!-- Categoria -->
                <div class="form-group">
                    <label for="category">Categoria</label>
                    <select id="category" name="category_id">
                        <option value="">-- Selecione a categoria --</option>
                        {% for cat in categories %}
                            <option value="{{ cat.id }}"
                                {% if product and product.category_id == cat.id %}selected{% endif %}>
                                {{ cat.nome }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Tipo -->
                <div class="form-group">
                    <label for="type">Tipo *</label>
                    <select id="type" name="type_id" required>
                        <option value="">-- Selecione o tipo --</option>
                        {% for tipo in tipos %}
                            <option value="{{ tipo.id }}" data-category="{{ tipo.category_id }}"
                                {% if product and product.type_id == tipo.id %}selected{% endif %}>
                                {{ tipo.nome }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Marca -->
                <div class="form-group">
                    <label for="brand">Marca *</label>
                    <select id="brand" name="brand_id" required>
                        <option value="">-- Selecione a marca --</option>
                        {% for marca in marcas %}
                            <option value="{{ marca.id }}"
                                {% if product and product.brand_id == marca.id %}selected{% endif %}>
                                {{ marca.nome }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Modelo -->
                <div class="form-group">
                    <label for="model">Modelo *</label>
                    <input type="text" id="model" name="model"
                           value="{{ product.model if product else '' }}" required>
                </div>

                <!-- Descrição -->
                <div class="form-group">
                    <label for="description">Descrição *</label>
                    <textarea id="description" name="description" required>{{ product.description if product else '' }}</textarea>
                </div>

                <!-- Controla por Série -->
                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" id="controla_por_serie" name="controla_por_serie"
                            {% if product and product.controla_por_serie %}checked{% endif %}>
                        Controla por Série/Tombo
                    </label>
                </div>

                <!-- Quantidade -->
                <div class="form-group" id="quantidade-container">
                    <label for="quantidade">Quantidade (para produtos sem série)</label>
                    <input type="number" id="quantidade" name="quantidade" min="1"
                           value="{{ product.quantidade if product else 1 }}">
                </div>

                <!-- Quantidade mínima -->
                <div class="form-group">
                    <label for="quantidade_minima">Quantidade mínima em estoque</label>
                    <input type="number" id="quantidade_minima" name="quantidade_minima" min="0"
                           value="{{ product.quantidade_minima if product else 0 }}">
                </div>

            </div>
        </fieldset>

        <!-- === ITEM FÍSICO === -->
<fieldset class="fieldset-section" id="item-fisico-section">
    <legend>Informações do Item Físico</legend>

    <div class="form-grid">

        <!-- Tombo ou Série -->
        <div class="form-group checkbox-group">
            <label>Tombo ou Série *</label>
            <div class="radio-group">
                <label>
                    <input type="radio" name="tombo" value="Sim" {% if item and item.tombo %}checked{% endif %}>
                    Tombo
                </label>
                <label>
                    <input type="radio" name="tombo" value="Não" {% if item and not item.tombo %}checked{% endif %}>
                    Série
                </label>
            </div>
        </div>

        <!-- Número do Tombo -->
        <div class="form-group" id="campo-tombo">
            <label for="num_tombo">Número do Tombo</label>
            <input type="text" id="num_tombo" name="num_tombo" value="{{ item.num_tombo_ou_serie if item and item.tombo else '' }}">
        </div>

        <!-- Número de Série -->
        <div class="form-group" id="campo-serie">
            <label for="num_serie">Número de Série</label>
            <input type="text" id="num_serie" name="num_serie" value="{{ item.num_tombo_ou_serie if item and not item.tombo else '' }}">
        </div>

        <!-- Estado -->
        <div class="form-group">
            <label for="state">Estado *</label>
            <select id="state" name="state_id" required>
                <option value="">-- Selecione o estado --</option>
                {% for estado in estados %}
                    <option value="{{ estado.id }}" {% if item and item.estado_id == estado.id %}selected{% endif %}>
                        {{ estado.nome }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <!-- Status -->
        <div class="form-group">
            <label for="status">Status *</label>
            <select id="status" name="status" required>
                {% set statuses = ['Disponível','Reservado','Alocado','Bloqueado','Devolvido','Emprestado'] %}
                {% for st in statuses %}
                    <option value="{{ st }}" {% if item and item.status == st %}selected{% endif %}>
                        {{ st }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <!-- Unidade Administrativa -->
        <div class="form-group">
            <label for="unit">Unidade Administrativa *</label>
            <select id="unit" name="unit_id" required>
                <option value="">-- Selecione a unidade --</option>
                {% for unidade in units %}
                    <option value="{{ unidade.id }}" {% if item and item.unit_id == unidade.id %}selected{% endif %}>
                        {{ unidade.name }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <!-- Data de Aquisição -->
        <div class="form-group">
            <label for="data_aquisicao">Data de Aquisição</label>
            <input type="date" id="data_aquisicao" name="data_aquisicao"
                   value="{{ item.data_aquisicao if item else '' }}">
        </div>

        <!-- Valor de Aquisição -->
        <div class="form-group">
            <label for="valor_aquisicao">Valor de Aquisição</label>
            <input type="number" id="valor_aquisicao" name="valor_aquisicao" step="0.01" min="0"
                   value="{{ item.valor_aquisicao if item else 0 }}">
        </div>

        <!-- Garantia Até -->
        <div class="form-group">
            <label for="garantia_ate">Garantia Até</label>
            <input type="date" id="garantia_ate" name="garantia_ate"
                   value="{{ item.garantia_ate if item else '' }}">
        </div>

        <!-- Observações -->
        <div class="form-group">
            <label for="observacao">Observações</label>
            <textarea id="observacao" name="observacao">{{ item.observacao if item else '' }}</textarea>
        </div>

    </div>
</fieldset>

        <!-- Botões -->
        <div class="buttons">
            <button type="submit" class="btn-submit">
                {% if action == 'add' %}Adicionar{% else %}Salvar Alterações{% endif %}
            </button>
            <a href="/products" class="btn-cancel">Cancelar</a>
        </div>

    </form>
</div>

<script>
window.addEventListener('load', function () {
    const controlaSerie = document.getElementById('controla_por_serie');
    const itemFisico = document.getElementById('item-fisico-section');
    const qtdContainer = document.getElementById('quantidade-container');

    const state = document.getElementById('state');
    const unit = document.getElementById('unit');
    const valor = document.getElementById('valor_aquisicao');

    function toggleModoProduto() {
        if (controlaSerie.checked) {
            itemFisico.style.display = 'block';
            qtdContainer.style.display = 'none';
            // Tornar campos obrigatórios
            state.required = true;
            unit.required = true;
            valor.required = true;
        } else {
            itemFisico.style.display = 'none';
            qtdContainer.style.display = 'block';
            // Campos não obrigatórios → envia default para evitar parsing error
            state.required = false;
            unit.required = false;
            valor.required = false;
            state.value = 0;
            unit.value = 0;
            valor.value = 0;
        }
    }

    function toggleCamposTombo() {
        const selecionado = document.querySelector('input[name="tombo"]:checked')?.value;
        const campoTombo = document.getElementById('campo-tombo');
        const campoSerie = document.getElementById('campo-serie');

        if (selecionado === 'Sim') {
            campoTombo.style.display = 'block';
            campoSerie.style.display = 'none';
            document.getElementById('num_tombo').required = true;
            document.getElementById('num_serie').required = false;
        } else if (selecionado === 'Não') {
            campoTombo.style.display = 'none';
            campoSerie.style.display = 'block';
            document.getElementById('num_tombo').required = false;
            document.getElementById('num_serie').required = true;
        } else {
            campoTombo.style.display = 'none';
            campoSerie.style.display = 'none';
            document.getElementById('num_tombo').required = false;
            document.getElementById('num_serie').required = false;
        }
    }

    document.querySelectorAll('input[name="tombo"]').forEach(radio =>
        radio.addEventListener('change', toggleCamposTombo)
    );
    controlaSerie.addEventListener('change', toggleModoProduto);

    toggleModoProduto();
    toggleCamposTombo();
});
</script>

<script>
window.addEventListener('load', function () {
    const categorySelect = document.getElementById('category');
    const typeSelect = document.getElementById('type');

    function filtrarTiposPorCategoria() {
        const selectedCategory = categorySelect.value;
        Array.from(typeSelect.options).forEach(option => {
            if (!option.value) return;
            option.style.display = (option.getAttribute('data-category') === selectedCategory) ? 'block' : 'none';
        });
        if (typeSelect.selectedOptions[0] && typeSelect.selectedOptions[0].style.display === 'none') {
            typeSelect.value = '';
        }
    }

    categorySelect.addEventListener('change', filtrarTiposPorCategoria);
    filtrarTiposPorCategoria();
});
</script>

{% endblock %}

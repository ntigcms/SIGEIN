{% extends "base.html" %}

{% block title %}Cadastro de Produto / Item{% endblock %}

{% block content %}
<style>
.container {
    max-width: 1200px;
    margin: 40px auto;
    padding: 0 20px;
}

.inventory-form {
    background: #ffffff;
    padding: 35px 45px;
    border-radius: 14px;
    box-shadow: 0 12px 35px rgba(0,0,0,0.08);
}

.fieldset-section {
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 25px 30px;
    margin-bottom: 35px;
}

.fieldset-section legend {
    padding: 0 12px;
    font-weight: 600;
    color: #1e293b;
    font-size: 1rem;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 22px 26px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group.full {
    grid-column: span 3;
}

.form-group label {
    font-size: 0.85rem;
    font-weight: 600;
    color: #475569;
    margin-bottom: 6px;
}

.form-group input,
.form-group select,
.form-group textarea {
    padding: 11px 13px;
    border-radius: 8px;
    border: 1px solid #cbd5e1;
    font-size: 0.9rem;
}

.form-group textarea {
    min-height: 90px;
    resize: vertical;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 3px rgba(37,99,235,0.15);
}

.checkbox-group {
    justify-content: center;
}

.radio-group {
    display: flex;
    gap: 20px;
    margin-top: 5px;
}

.buttons {
    display: flex;
    justify-content: flex-end;
    gap: 15px;
    margin-top: 30px;
}

.btn-submit {
    background: #2563eb;
    color: #fff;
    padding: 11px 24px;
    border-radius: 8px;
    border: none;
    font-weight: 600;
    cursor: pointer;
}

.btn-submit:hover {
    background: #1d4ed8;
}

.btn-cancel {
    padding: 11px 24px;
    border-radius: 8px;
    border: 1px solid #cbd5e1;
    color: #334155;
    text-decoration: none;
}

.btn-cancel:hover {
    background: #f1f5f9;
}

@media (max-width: 1024px) {
    .form-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    .form-group.full {
        grid-column: span 2;
    }
}

@media (max-width: 640px) {
    .form-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<div class="container">
    <h2 style="text-align:center; margin-bottom:30px;">
        {% if action == 'add' %}Adicionar Produto / Item{% else %}Editar Produto / Item{% endif %}
    </h2>

    <form method="POST"
          action="{% if action == 'add' %}/products/add{% else %}/products/edit/{{ product.id }}{% endif %}"
          class="inventory-form">

        <!-- PRODUTO -->
        <fieldset class="fieldset-section">
            <legend>Informações do Produto</legend>

            <div class="form-grid">

                <div class="form-group">
                    <label>Nome do Produto *</label>
                    <input type="text" name="name" value="{{ product.name if product else '' }}" required>
                </div>

                <div class="form-group">
                    <label>Categoria</label>
                    <select name="category_id" id="category">
                        <option value="">-- Selecione --</option>
                        {% for cat in categories %}
                        <option value="{{ cat.id }}" {% if product and product.category_id == cat.id %}selected{% endif %}>
                            {{ cat.nome }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label>Tipo *</label>
                    <select name="type_id" id="type" required>
                        <option value="">-- Selecione --</option>
                        {% for tipo in tipos %}
                        <option value="{{ tipo.id }}" data-category="{{ tipo.category_id }}"
                            {% if product and product.type_id == tipo.id %}selected{% endif %}>
                            {{ tipo.nome }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label>Marca *</label>
                    <select name="brand_id" required>
                        <option value="">-- Selecione --</option>
                        {% for marca in marcas %}
                        <option value="{{ marca.id }}" {% if product and product.brand_id == marca.id %}selected{% endif %}>
                            {{ marca.nome }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label>Modelo *</label>
                    <input type="text" name="model" value="{{ product.model if product else '' }}" required>
                </div>

                <div class="form-group full">
                    <label>Descrição *</label>
                    <textarea name="description" required>{{ product.description if product else '' }}</textarea>
                </div>

                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" id="controla_por_serie" name="controla_por_serie"
                        {% if product and product.controla_por_serie %}checked{% endif %}>
                        Controla por Série/Tombo
                    </label>
                </div>

                <div class="form-group" id="quantidade-container">
                    <label>Quantidade</label>
                    <input type="number" name="quantidade" value="{{ product.quantidade if product else 1 }}">
                </div>

                <div class="form-group">
                    <label>Quantidade mínima</label>
                    <input type="number" name="quantidade_minima" value="{{ product.quantidade_minima if product else 0 }}">
                </div>

            </div>
        </fieldset>

        <!-- ITEM FÍSICO -->
        <fieldset class="fieldset-section" id="item-fisico-section">
            <legend>Informações do Item Físico</legend>

            <div class="form-grid">

                <div class="form-group">
                    <label>Tombo ou Série</label>
                    <div class="radio-group">
                        <label><input type="radio" name="tombo" value="Sim" {% if item and item.tombo %}checked{% endif %}>Tombo</label>
                        <label><input type="radio" name="tombo" value="Não" {% if item and not item.tombo %}checked{% endif %}>Série</label>
                    </div>
                </div>

            <div class="form-group" id="campo-tombo" style="display:none;">
                    <label>Número do Tombo</label>
                    <input type="text" name="num_tombo" id="num_tombo"
                        value="{{ item.num_tombo_ou_serie if item and item.tombo }}">
            </div>

            <div class="form-group" id="campo-serie" style="display:none;">
                    <label>Número de Série</label>
                    <input type="text" name="num_serie" id="num_serie"
                        value="{{ item.num_tombo_ou_serie if item and not item.tombo }}">
            </div>

                <div class="form-group">
                    <label>Estado</label>
                    <select name="state_id" id="state">
                        {% for estado in estados %}
                        <option value="{{ estado.id }}">{{ estado.nome }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label>Status</label>
                    <select name="status">
                        <option>Disponível</option>
                        <option>Reservado</option>
                        <option>Alocado</option>
                        <option>Bloqueado</option>
                        <option>Devolvido</option>
                        <option>Emprestado</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Unidade</label>
                    <select name="unit_id" id="unit">
                        {% for u in units %}
                        <option value="{{ u.id }}">{{ u.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label>Data de Aquisição</label>
                    <input type="date" name="data_aquisicao" value="{{ item.data_aquisicao.strftime('%Y-%m-%d') if item and item.data_aquisicao }}">
                </div>

                <div class="form-group">
                    <label>Valor</label>
                    <input type="text" name="valor_aquisicao" id="valor_aquisicao" placeholder="R$ 0,00" value="{{ 'R$ {:,.2f}'.format(item.valor_aquisicao).replace(',', 'X').replace('.', ',').replace('X', '.') if item and item.valor_aquisicao }}">
                </div>

                <div class="form-group full">
                    <label>Observações</label>
                    <textarea name="observacao">{{ item.observacao if item }}</textarea>
                </div>

            </div>
        </fieldset>

        <div class="buttons">
            <button type="submit" class="btn-submit">Salvar</button>
            <a href="/products" class="btn-cancel">Cancelar</a>
        </div>

    </form>
</div>


<script>
window.addEventListener('load', function () {
    const controlaSerie = document.getElementById('controla_por_serie');
    const itemFisico = document.getElementById('item-fisico-section');
    const qtdContainer = document.getElementById('quantidade-container');

    const state = document.getElementById('state');
    const unit = document.getElementById('unit');
    const valor = document.getElementById('valor_aquisicao');

    function toggleModoProduto() {
        if (controlaSerie.checked) {
            itemFisico.style.display = 'block';
            qtdContainer.style.display = 'none';
            // Tornar campos obrigatórios
            state.required = true;
            unit.required = true;
            valor.required = true;
        } else {
            itemFisico.style.display = 'none';
            qtdContainer.style.display = 'block';
            // Campos não obrigatórios → envia default para evitar parsing error
            state.required = false;
            unit.required = false;
            valor.required = false;
            state.value = 0;
            unit.value = 0;
            valor.value = 0;
        }
    }

    function toggleCamposTombo() {
        const selecionado = document.querySelector('input[name="tombo"]:checked')?.value;
        const campoTombo = document.getElementById('campo-tombo');
        const campoSerie = document.getElementById('campo-serie');

        if (selecionado === 'Sim') {
            campoTombo.style.display = 'block';
            campoSerie.style.display = 'none';
            document.getElementById('num_tombo').required = true;
            document.getElementById('num_serie').required = false;
        } else if (selecionado === 'Não') {
            campoTombo.style.display = 'none';
            campoSerie.style.display = 'block';
            document.getElementById('num_tombo').required = false;
            document.getElementById('num_serie').required = true;
        } else {
            campoTombo.style.display = 'none';
            campoSerie.style.display = 'none';
            document.getElementById('num_tombo').required = false;
            document.getElementById('num_serie').required = false;
        }
    }

    document.querySelectorAll('input[name="tombo"]').forEach(radio =>
        radio.addEventListener('change', toggleCamposTombo)
    );
    controlaSerie.addEventListener('change', toggleModoProduto);

    toggleModoProduto();
    toggleCamposTombo();
});
</script>

<script>
window.addEventListener('load', function () {
    const categorySelect = document.getElementById('category');
    const typeSelect = document.getElementById('type');

    function filtrarTiposPorCategoria() {
        const selectedCategory = categorySelect.value;
        Array.from(typeSelect.options).forEach(option => {
            if (!option.value) return;
            option.style.display = (option.getAttribute('data-category') === selectedCategory) ? 'block' : 'none';
        });
        if (typeSelect.selectedOptions[0] && typeSelect.selectedOptions[0].style.display === 'none') {
            typeSelect.value = '';
        }
    }

    categorySelect.addEventListener('change', filtrarTiposPorCategoria);
    filtrarTiposPorCategoria();
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const input = document.getElementById("valor_aquisicao");
    if (!input) return;

    const formatter = new Intl.NumberFormat("pt-BR", {
        style: "currency",
        currency: "BRL"
    });

    function formatarDireitaParaEsquerda(valor) {
        // mantém apenas números
        const numeros = valor.replace(/\D/g, "");

        // converte centavos
        const numero = (Number(numeros) / 100).toFixed(2);

        return formatter.format(numero);
    }

    input.addEventListener("input", function () {
        input.value = formatarDireitaParaEsquerda(input.value);
    });

    // Remove máscara antes de enviar
    input.form.addEventListener("submit", function () {
        input.value = input.value
            .replace(/\./g, "")
            .replace(",", ".")
            .replace("R$", "")
            .trim();
    });
});
</script>


{% endblock %}
